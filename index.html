¬°Claro que s√≠\! He realizado las modificaciones que solicitaste para mejorar la herramienta.

Aqu√≠ tienes un resumen de los cambios implementados:

1.  **Nuevo "Modo M√∫ltiple" para Env√≠os:**

      * Se agreg√≥ un selector para cambiar entre "Modo Individual" (como funcionaba antes) y "Modo M√∫ltiple".
      * En el modo m√∫ltiple, en lugar de generar una vista previa, el bot√≥n **"Agregar Etiqueta al Lote"** a√±ade los datos del formulario a una lista.
      * Puedes ver todas las etiquetas que has agregado a la lista y eliminar cualquiera si te equivocas.
      * Un nuevo bot√≥n **"Procesar Lote e Imprimir"** toma todas las etiquetas de la lista y las prepara para la impresi√≥n, colocando hasta **cuatro etiquetas diferentes por p√°gina**, optimizando el uso del papel.

2.  **Mejoras en la Ventana de Importaci√≥n:**

      * La ventana para importar clientes desde Excel ahora tiene un **bot√≥n "X" en la esquina superior derecha** para cerrarla f√°cilmente.
      * Tambi√©n puedes **hacer clic en el fondo oscuro** fuera de la ventana para cerrarla.

3.  **Importaci√≥n de Transporte:**

      * El sistema ahora es capaz de **leer y cargar autom√°ticamente el "Medio de Transporte"** desde el archivo Excel que importas, junto con los dem√°s datos del cliente. Esto agiliza a√∫n m√°s el proceso si est√°s re-ingresando una venta anterior.

A continuaci√≥n, te entrego el c√≥digo HTML completo con todas las mejoras integradas. Simplemente copia y pega todo el contenido en un archivo `.html` y √°brelo en tu navegador.

-----

### C√≥digo HTML Actualizado

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Etiquetas - FUCAS SPA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .selector-section, .form-section, .preview-section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button-group-flex { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .flex-btn { padding: 15px 30px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 150px; text-align: center; }
        .flex-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .flex-btn:hover:not(.active) { border-color: #2563eb; background: #f8fafc; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #374151; }
        .form-group label.required::after { content: " *"; color: #ef4444; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #d97706; color: white; }
        .btn-warning:hover { background-color: #b45309; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .preview-section { display: none; }
        .preview-section.active { display: block; }
        .success-message { background-color: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.active { display: block; }
        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .copy-section { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .copy-textarea { width: 100%; height: 200px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px; background: white; resize: vertical; }
        .hidden { display: none !important; }
        
        /* Estilos para el modal de importaci√≥n */
        .modal-importar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { position: relative; background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #888; }
        .modal-close:hover { color: #333; }
        .upload-mini { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc; }
        .upload-mini input[type="file"] { display: none; }
        .upload-mini label { cursor: pointer; display: inline-block; }

        /* Estilos para Lote */
        #batchSection { display: none; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-top: 25px; }
        .batch-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; }
        .batch-item-info { font-size: 14px; }
        .batch-item-info strong { color: #1d4ed8; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .button-group-flex, .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Procesador de Etiquetas - FUCAS SPA</h1><p>Sistema interactivo de generaci√≥n de etiquetas</p></div>
        
        <div class="selector-section">
            <h3 style="margin-bottom: 15px; text-align: center;">1. Selecciona el tipo de operaci√≥n:</h3>
            <div class="button-group-flex">
                <button class="flex-btn" onclick="seleccionarTipo('RETIRO', this)">üè™ RETIRO</button>
                <button class="flex-btn" onclick="seleccionarTipo('ENVIO', this)">üì¶ ENV√çO</button>
                <button class="flex-btn" onclick="seleccionarTipo('PROVISORIA', this)">‚è≥ PROVISORIA</button>
            </div>
        </div>

        <div id="modoSelectorSection" class="selector-section hidden">
            <h3 style="margin-bottom: 15px; text-align: center;">2. Selecciona el modo de trabajo:</h3>
            <div class="button-group-flex">
                <button class="flex-btn" onclick="seleccionarModo('individual', this)">üë§ Modo Individual</button>
                <button class="flex-btn" onclick="seleccionarModo('multiple', this)">üìë Modo M√∫ltiple</button>
            </div>
        </div>

        <div id="formRETIRO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üìã Formulario de Retiro</h2>
            <div class="form-grid">
                <div class="form-group"><label for="retiroVendedor">Vendedor</label><select id="retiroVendedor"></select></div>
                <div class="form-group"><label for="retiroCliente" class="required">Cliente</label><input type="text" id="retiroCliente"></div>
                <div class="form-group"><label for="retiroNotaVenta" class="required">Nota de Venta</label><input type="text" id="retiroNotaVenta"></div>
                <div class="form-group"><label for="retiroBultos">Copias de Etiqueta</label><input type="number" id="retiroBultos" min="1" value="1"></div>
                <div class="form-group"><label for="retiroObservaciones">Observaciones</label><textarea id="retiroObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarRetiro()">Generar Vista Previa</button></div>
        </div>

        <div id="formPROVISORIA" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">‚è≥ Formulario de Etiqueta Provisoria</h2>
            <div class="form-grid">
                <div class="form-group"><label for="provisoriaVendedor">Vendedor</label><select id="provisoriaVendedor"></select></div>
                <div class="form-group"><label for="provisoriaCliente" class="required">Cliente</label><input type="text" id="provisoriaCliente"></div>
                <div class="form-group"><label for="provisoriaNotaVenta" class="required">Nota de Venta</label><input type="text" id="provisoriaNotaVenta"></div>
                <div class="form-group"><label for="provisoriaBultos">Copias de Etiqueta</label><input type="number" id="provisoriaBultos" min="1" value="1"></div>
                <div class="form-group"><label for="provisoriaObservaciones">Observaciones</label><textarea id="provisoriaObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarProvisoria()">Generar Vista Previa</button></div>
        </div>

        <div id="formENVIO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üì¶ Formulario de Env√≠o</h2>
            <div class="form-group"><label for="envioVendedor">Vendedor (Remitente)</label><select id="envioVendedor"></select></div>
            <h3 style="margin-bottom: 15px; color: #374151;">Datos del Destinatario</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioDestinatario" class="required">Destinatario</label><input type="text" id="envioDestinatario"></div>
                <div class="form-group">    
                    <label for="envioRut" class="required">RUT</label>    
                    <input type="text" id="envioRut" onblur="buscarClientePorRut()">    
                    <button type="button" class="btn btn-warning" onclick="mostrarImportarCliente()" style="margin-top: 5px; font-size: 12px;">
                        üìÇ Importar desde Excel
                    </button>
                </div>
                <div class="form-group"><label for="envioTelefono" class="required">Tel√©fono</label><input type="text" id="envioTelefono"></div>
                <div class="form-group"><label for="envioDireccion" class="required">Direcci√≥n</label><input type="text" id="envioDireccion"></div>
                <div class="form-group"><label for="envioReferencia">Referencia (Opcional)</label><input type="text" id="envioReferencia" placeholder="Ej: Casa rejas verdes, al lado de..."></div>
                <div class="form-group">
                    <label for="envioComuna" class="required">Comuna</label>
                    <input type="text" id="envioComuna" list="comunasList" placeholder="Escribe para buscar...">
                    <datalist id="comunasList"></datalist>
                </div>
                <div class="form-group"><label for="envioTipo">Tipo de Env√≠o</label><select id="envioTipo"><option value="Domicilio">Domicilio</option><option value="Oficina">Oficina</option></select></div>
            </div>
            <h3 style="margin: 25px 0 15px 0; color: #374151;">Datos del Env√≠o</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioNotaVenta" class="required">Nota de Venta</label><input type="text" id="envioNotaVenta"></div>
                <div class="form-group"><label for="envioBultos">Bultos (N¬∞ de etiquetas)</label><input type="number" id="envioBultos" min="1" value="1"></div>
                <div class="form-group"><label for="envioTransporte">Transporte</label><select id="envioTransporte"><option value="">Seleccionar...</option><option value="TUTTO PETS">TUTTO PETS</option><option value="JULIO MILLAN">JULIO MILLAN</option><option value="CHRISTIAN ALIAGA">CHRISTIAN ALIAGA</option><option value="Starken">Starken</option><option value="Chilexpress">Chilexpress</option><option value="Blue Express">Blue Express</option><option value="Correos de Chile">Correos de Chile</option><option value="Shipit">Shipit</option><option value="Shippify">Shippify</option><option value="VARMONTT">VARMONTT</option><option value="PULLMAN">PULLMAN</option><option value="CACEM">CACEM</option><option value="MERCOSUR">MERCOSUR</option><option value="TVP">TVP</option><option value="Otro">Otro</option></select></div>
                <div class="form-group hidden" id="transporteOtroGroup"><label for="envioTransporteOtro">Especificar Transporte</label><input type="text" id="envioTransporteOtro"></div>
                <div class="form-group"><label for="envioPago">Pago</label><select id="envioPago"><option value="">Seleccionar...</option><option value="Pagado">Pagado</option><option value="Por Pagar">Por Pagar</option><option value="Contra Entrega">Contra Entrega</option></select></div>
            </div>
            <div id="envioBtnGroup" class="btn-group">
                <button id="btnProcesarEnvio" class="btn btn-primary" onclick="procesarEnvio()">Generar Vista Previa</button>
            </div>

            <div id="batchSection">
                <h3 style="margin-bottom: 15px; color: #374151;">üìã Lote de Etiquetas Agregadas (<span id="batchCount">0</span>)</h3>
                <ul id="batchList" class="batch-list">
                    </ul>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="procesarLote()">üñ®Ô∏è Procesar Lote e Imprimir</button>
                </div>
            </div>
        </div>
        
        <div id="modalImportarCliente" class="modal-importar" style="display: none;" onclick="cerrarModalSiEsAfuera(event)">
            <div class="modal-content">
                <span class="modal-close" onclick="cerrarImportarCliente()">√ó</span>
                <h3>üìÇ Importar Cliente desde Excel</h3>
                <p>Sube un archivo Excel de etiquetas previas para cargar autom√°ticamente los datos del cliente.</p>
                <div class="upload-mini" style="margin-top: 15px;">
                    <input type="file" id="fileImportCliente" accept=".xlsx,.xls" onchange="procesarArchivoImportado(event)">
                    <label for="fileImportCliente" class="btn btn-primary">Seleccionar Archivo Excel</label>
                </div>
                <div id="resultadoImportacion" style="margin-top: 15px; display: none;">
                    <div id="datosImportados"></div>
                    <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                        <button class="btn btn-success" onclick="aplicarDatosImportados()">‚úÖ Usar estos datos</button>
                        <button class="btn btn-secondary" onclick="cerrarImportarCliente()">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="previewSection" class="preview-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üëÄ Vista Previa</h2>
            <div id="successMessage" class="success-message"><strong>‚úÖ Datos correctos.</strong><p>Usa las opciones de abajo para imprimir o exportar.</p></div>
            <div class="table-container"><table><tbody id="previewTable"></tbody></table></div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="generarVistaImprimible()">üñ®Ô∏è Imprimir Etiquetas</button>
                <button class="btn btn-success" onclick="generarExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-success" onclick="copiarParaSheets()">üìã Copiar para Sheets</button>
                <button class="btn btn-warning" onclick="mostrarDatosCopiables()">üìù Copiar Datos</button>
                <button class="btn btn-secondary" onclick="volverInicio()">üîÑ Nuevo</button>
            </div>
            <div id="copySection" class="copy-section hidden">
                <h3 style="margin-bottom: 15px;">üìã Datos para Copiar</h3>
                <textarea id="copyTextarea" class="copy-textarea" readonly></textarea>
                <div style="margin-top: 10px; text-align: center;"><button class="btn btn-warning" onclick="copiarAlPortapapeles()">Copiar</button></div>
            </div>
        </div>
    </div>

    <script>
        let processedData = null;
        let batchData = [];
        let modoActual = 'individual';
        const vendedores = { "LEONARDO CASTRO": "2 3347 5040", "ANDREA FUENTES": "+56 9 6863 7136", "JOSELYN GOMEZ": "+56 9 3096 8640", "YEIMY REALPE": "+56 9 8544 9261", "LESLIE RIOS": "+56 9 3457 2139", "ADM": "+56 9 4755 4045" };
        const comunasPorRegion = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"], "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"], "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±al√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"], "Libertador General Bernardo O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "√ëuble": ["Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Quirihue", "R√°nquil", "Treguaco", "Bulnes", "Chill√°n Viejo", "Chill√°n", "El Carmen", "Pemuco", "Pinto", "Quill√≥n", "San Ignacio", "Yungay", "Coihueco", "√ëiqu√©n", "San Carlos", "San Fabi√°n", "San Nicol√°s"], "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"], "La Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"], "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"], "Ays√©n del General Carlos Ib√°√±ez del Campo": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"], "Magallanes y de la Ant√°rtica Chilena": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"] };
        
        // --- INICIO C√ìDIGO DE IMPORTACI√ìN DE CLIENTE ---
        let datosClienteImportado = null;

        function mostrarImportarCliente() {
            document.getElementById('modalImportarCliente').style.display = 'flex';
        }

        function cerrarImportarCliente() {
            document.getElementById('modalImportarCliente').style.display = 'none';
            document.getElementById('resultadoImportacion').style.display = 'none';
            document.getElementById('fileImportCliente').value = '';
            datosClienteImportado = null;
        }
        
        function cerrarModalSiEsAfuera(event) {
            if (event.target === document.getElementById('modalImportarCliente')) {
                cerrarImportarCliente();
            }
        }

        async function procesarArchivoImportado(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                datosClienteImportado = extraerDatosClienteExcel(jsonData);
                if (datosClienteImportado && datosClienteImportado.nombre) {
                    mostrarDatosImportados(datosClienteImportado);
                } else {
                    alert('No se pudieron extraer datos v√°lidos del archivo Excel. Aseg√∫rate de que es un archivo de etiquetas generado por este sistema.');
                }
            } catch (error) {
                console.error('Error procesando archivo:', error);
                alert('Error al leer el archivo: ' + error.message);
            }
        }

        function extraerDatosClienteExcel(jsonData) {
            const cliente = {};
            const camposMapeados = {
                'DESTINATARIO': 'nombre',
                'RUT DESTINATARIO': 'rut',
                'TEL√âFONO DESTINO': 'telefono',
                'DIRECCI√ìN DESTINO': 'direccion',
                'REFERENCIA': 'referencia',
                'COMUNA DESTINO': 'comuna',
                'REGI√ìN': 'region',
                'VENDEDOR': 'vendedor',
                'MEDIO DE TRANSPORTE': 'transporte' // <-- NUEVO
            };
            for (let i = 0; i < jsonData.length; i++) {
                const fila = jsonData[i];
                if (fila && fila.length >= 2 && fila[0] && fila[1]) {
                    const campo = fila[0].toString().trim().toUpperCase();
                    const valor = fila[1].toString().trim();
                    if (camposMapeados[campo]) {
                        cliente[camposMapeados[campo]] = valor;
                    }
                }
            }
            return cliente;
        }

        function mostrarDatosImportados(datos) {
            const container = document.getElementById('datosImportados');
            container.innerHTML = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; border: 1px solid #0ea5e9;">
                    <h4 style="margin-bottom: 10px;">üìã Datos encontrados:</h4>
                    <p><strong>Cliente:</strong> ${datos.nombre || 'No encontrado'}</p>
                    <p><strong>RUT:</strong> ${datos.rut || 'No encontrado'}</p>
                    <p><strong>Tel√©fono:</strong> ${datos.telefono || 'No encontrado'}</p>
                    <p><strong>Direcci√≥n:</strong> ${datos.direccion || 'No encontrado'}</p>
                    <p><strong>Referencia:</strong> ${datos.referencia || 'No encontrado'}</p>
                    <p><strong>Comuna:</strong> ${datos.comuna || 'No encontrado'}</p>
                    <p><strong>Transporte:</strong> ${datos.transporte || 'No encontrado'}</p> 
                </div>
            `;
            document.getElementById('resultadoImportacion').style.display = 'block';
        }

        function aplicarDatosImportados() {
            if (!datosClienteImportado) {
                alert('No hay datos para aplicar');
                return;
            }
            document.getElementById('envioDestinatario').value = datosClienteImportado.nombre || '';
            document.getElementById('envioRut').value = datosClienteImportado.rut || '';
            document.getElementById('envioTelefono').value = datosClienteImportado.telefono || '';
            document.getElementById('envioDireccion').value = datosClienteImportado.direccion || '';
            document.getElementById('envioReferencia').value = datosClienteImportado.referencia || '';
            document.getElementById('envioComuna').value = datosClienteImportado.comuna || '';
            
            // --- NUEVO: Aplicar transporte ---
            if (datosClienteImportado.transporte) {
                const selectTransporte = document.getElementById('envioTransporte');
                const optionExists = [...selectTransporte.options].some(opt => opt.value === datosClienteImportado.transporte);
                if (optionExists) {
                    selectTransporte.value = datosClienteImportado.transporte;
                    document.getElementById('transporteOtroGroup').classList.add('hidden');
                } else {
                    selectTransporte.value = 'Otro';
                    document.getElementById('transporteOtroGroup').classList.remove('hidden');
                    document.getElementById('envioTransporteOtro').value = datosClienteImportado.transporte;
                }
            }
            // --- FIN NUEVO ---

            alert('‚úÖ Datos del cliente cargados exitosamente desde el archivo Excel');
            cerrarImportarCliente();
            if (datosClienteImportado.rut) {
                const clienteCache = {
                    rut: datosClienteImportado.rut,
                    nombre: datosClienteImportado.nombre,
                    telefono: datosClienteImportado.telefono,
                    direccion: datosClienteImportado.direccion,
                    referencia: datosClienteImportado.referencia,
                    comuna: datosClienteImportado.comuna,
                    transporte: datosClienteImportado.transporte, // <-- NUEVO
                    fechaImportacion: new Date().toISOString()
                };
                let clientesGuardados = JSON.parse(localStorage.getItem('clientesImportados') || '[]');
                clientesGuardados = clientesGuardados.filter(c => c.rut !== clienteCache.rut);
                clientesGuardados.push(clienteCache);
                if (clientesGuardados.length > 50) {
                    clientesGuardados = clientesGuardados.slice(-50);
                }
                localStorage.setItem('clientesImportados', JSON.stringify(clientesGuardados));
            }
        }

        function buscarClientePorRut() {
            const rut = document.getElementById('envioRut').value.trim();
            if (!rut || rut.length < 8) {
                limpiarCamposCliente();
                return;
            }
            const clientesImportados = JSON.parse(localStorage.getItem('clientesImportados') || '[]');
            const clienteEncontrado = clientesImportados.find(c =>
                c.rut.replace(/[.-]/g, '') === rut.replace(/[.-]/g, '')
            );
            if (clienteEncontrado) {
                document.getElementById('envioDestinatario').value = clienteEncontrado.nombre || '';
                document.getElementById('envioTelefono').value = clienteEncontrado.telefono || '';
                document.getElementById('envioDireccion').value = clienteEncontrado.direccion || '';
                document.getElementById('envioReferencia').value = clienteEncontrado.referencia || '';
                document.getElementById('envioComuna').value = clienteEncontrado.comuna || '';
                if (clienteEncontrado.transporte) { // <-- NUEVO
                    document.getElementById('envioTransporte').value = clienteEncontrado.transporte;
                }
                mostrarMensajeTemporalCliente(`‚úÖ Cliente encontrado en cach√©: ${clienteEncontrado.nombre}`);
                return;
            }
        }

        function mostrarMensajeTemporalCliente(mensaje) {
            let msgDiv = document.getElementById('mensajeCliente');
            if (!msgDiv) {
                msgDiv = document.createElement('div');
                msgDiv.id = 'mensajeCliente';
                msgDiv.style.cssText = `background-color: #d1fae5; border: 1px solid #10b981; color: #065f46; padding: 8px 12px; border-radius: 6px; margin-top: 5px; font-size: 14px;`;
                document.getElementById('envioRut').parentNode.appendChild(msgDiv);
            }
            msgDiv.innerHTML = mensaje;
            msgDiv.style.display = 'block';
            setTimeout(() => { msgDiv.style.display = 'none'; }, 4000);
        }

        function limpiarCamposCliente() {
            document.getElementById('envioDestinatario').value = '';
            document.getElementById('envioTelefono').value = '';
            document.getElementById('envioDireccion').value = '';
            document.getElementById('envioReferencia').value = '';
            document.getElementById('envioComuna').value = '';
            const msgDiv = document.getElementById('mensajeCliente');
            if (msgDiv) { msgDiv.style.display = 'none'; }
        }
        // --- FIN C√ìDIGO DE IMPORTACI√ìN DE CLIENTE ---

        function poblarSelect(selectId, data, useKeysAsValue = true) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            for (const key in data) {
                const option = document.createElement('option');
                option.value = useKeysAsValue ? key : data[key];
                option.textContent = key;
                select.appendChild(option);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const datalistComunas = document.getElementById('comunasList');
            let todasLasComunas = [];
            for (const region in comunasPorRegion) {
                comunasPorRegion[region].forEach(comuna => {
                    todasLasComunas.push({
                        nombre: comuna,
                        textoCompleto: `${comuna} (${region})`
                    });
                });
            }
            todasLasComunas.sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            todasLasComunas.forEach(item => {
                const option = document.createElement('option');
                option.value = item.textoCompleto;
                datalistComunas.appendChild(option);
            });

            poblarSelect('retiroVendedor', vendedores, true);
            poblarSelect('provisoriaVendedor', vendedores, true);
            poblarSelect('envioVendedor', vendedores, true);

            document.getElementById('envioTransporte').addEventListener('change', function() {
                const pagoSelect = document.getElementById('envioPago');
                document.getElementById('transporteOtroGroup').classList.toggle('hidden', this.value !== 'Otro');
                pagoSelect.disabled = false;
                if (this.value === 'TUTTO PETS') {
                    pagoSelect.value = 'Pagado';
                    pagoSelect.disabled = true;
                    alert('ATENCI√ìN: Env√≠o por TUTTO PETS debe ser PAGADO y cobrado en la nota de venta.');
                } else if (this.value === 'JULIO MILLAN' || this.value === 'CHRISTIAN ALIAGA') {
                    const courierName = this.value;
                    alert(`INFO: Para env√≠os con ${courierName}, si seleccionas "Por Pagar", el cobro lo gestiona directamente √©l.`);
                }
            });
        });
        
        // --- NUEVAS FUNCIONES PARA MODO M√öLTIPLE ---
        function seleccionarModo(modo, element) {
            modoActual = modo;
            document.querySelectorAll('#modoSelectorSection .flex-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');

            const btnProcesar = document.getElementById('btnProcesarEnvio');
            const batchSection = document.getElementById('batchSection');
            
            if (modo === 'multiple') {
                btnProcesar.textContent = '‚ûï Agregar Etiqueta al Lote';
                batchSection.style.display = 'block';
            } else {
                btnProcesar.textContent = 'Generar Vista Previa';
                batchSection.style.display = 'none';
            }
            // Limpiar lote si se cambia de modo
            batchData = [];
            renderizarLote();
        }

        function renderizarLote() {
            const list = document.getElementById('batchList');
            const count = document.getElementById('batchCount');
            list.innerHTML = '';
            batchData.forEach((item, index) => {
                const destinatario = item.datos.find(d => d[0] === 'DESTINATARIO')?.[1] || 'N/A';
                const nv = item.datos.find(d => d[0] === 'NOTA DE VENTA')?.[1] || 'N/A';
                const li = document.createElement('li');
                li.className = 'batch-item';
                li.innerHTML = `
                    <div class="batch-item-info">
                        <strong>${index + 1}.</strong> ${destinatario} (NV: ${nv})
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="eliminarDelLote(${index})">Eliminar</button>
                `;
                list.appendChild(li);
            });
            count.textContent = batchData.length;
        }

        function eliminarDelLote(index) {
            batchData.splice(index, 1);
            renderizarLote();
        }

        function limpiarFormularioEnvio() {
            // Limpia campos espec√≠ficos para la siguiente etiqueta, pero mantiene el vendedor
            document.getElementById('envioDestinatario').value = '';
            document.getElementById('envioRut').value = '';
            document.getElementById('envioTelefono').value = '';
            document.getElementById('envioDireccion').value = '';
            document.getElementById('envioReferencia').value = '';
            document.getElementById('envioComuna').value = '';
            document.getElementById('envioNotaVenta').value = '';
            document.getElementById('envioBultos').value = '1';
        }
        // --- FIN NUEVAS FUNCIONES ---

        function seleccionarTipo(tipo, element) {
            document.querySelectorAll('.selector-section .flex-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.form-section, #previewSection').forEach(s => s.classList.remove('active'));
            document.getElementById(`form${tipo}`).classList.add('active');
            
            const modoSelector = document.getElementById('modoSelectorSection');
            if (tipo === 'ENVIO') {
                modoSelector.classList.remove('hidden');
                // Forzar selecci√≥n de modo si no hay uno activo
                if (!document.querySelector('#modoSelectorSection .flex-btn.active')) {
                    document.querySelector('#modoSelectorSection .flex-btn').click();
                }
            } else {
                modoSelector.classList.add('hidden');
            }
        }
        
        function procesarRetiro() {
            const cliente = document.getElementById('retiroCliente').value.trim();
            const notaVenta = document.getElementById('retiroNotaVenta').value.trim();
            if (!cliente || !notaVenta) {
                alert('Los campos Cliente y Nota de Venta son obligatorios.');
                return;
            }
            const vendedorSeleccionado = document.getElementById('retiroVendedor').value;
            const fecha = new Date();
            processedData = {
                tipo: 'RETIRO',
                bultos: parseInt(document.getElementById('retiroBultos').value) || 1,
                datos: [
                    ['CLIENTE', cliente],
                    ['NOTA DE VENTA', notaVenta],
                    ['FECHA', `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`],
                    ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                    ['OBSERVACIONES', document.getElementById('retiroObservaciones').value.trim()]
                ]
            };
            mostrarVistaPrevia();
        }

        function procesarProvisoria() {
            const cliente = document.getElementById('provisoriaCliente').value.trim();
            const notaVenta = document.getElementById('provisoriaNotaVenta').value.trim();
            if (!cliente || !notaVenta) {
                alert('Los campos Cliente y Nota de Venta son obligatorios.');
                return;
            }
            const vendedorSeleccionado = document.getElementById('provisoriaVendedor').value;
            const fecha = new Date();
            processedData = {
                tipo: 'PROVISORIA',
                bultos: parseInt(document.getElementById('provisoriaBultos').value) || 1,
                datos: [
                    ['CLIENTE', cliente],
                    ['NOTA DE VENTA', notaVenta],
                    ['FECHA', `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`],
                    ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                    ['OBSERVACIONES', document.getElementById('provisoriaObservaciones').value.trim()]
                ]
            };
            mostrarVistaPrevia();
        }
        
        function obtenerDatosEnvioDelFormulario() {
            const campos = { 
                destinatario: document.getElementById('envioDestinatario').value.trim(), 
                rut: document.getElementById('envioRut').value.trim(), 
                telefono: document.getElementById('envioTelefono').value.trim(), 
                direccion: document.getElementById('envioDireccion').value.trim(),
                comuna: document.getElementById('envioComuna').value.trim(),
                notaVenta: document.getElementById('envioNotaVenta').value.trim()
            };
            const referencia = document.getElementById('envioReferencia').value.trim();
            
            const faltantes = Object.keys(campos).filter(k => !campos[k]);
            if (faltantes.length > 0) {
                alert(`Faltan campos obligatorios: ${faltantes.join(', ')}`);
                return null;
            }

            let transporte = document.getElementById('envioTransporte').value;
            if (transporte === 'Otro') { transporte = document.getElementById('envioTransporteOtro').value.trim() || 'Otro (sin especificar)'; }
            
            const comunaCompleta = campos.comuna;
            const nombreComuna = comunaCompleta.includes(' (') ? comunaCompleta.substring(0, comunaCompleta.lastIndexOf(' (')) : comunaCompleta;
            let region = 'No encontrada';
            for (const r in comunasPorRegion) { if (comunasPorRegion[r].includes(nombreComuna)) { region = r; break; } }
            
            let ciudad = nombreComuna;
            if (region === 'Metropolitana de Santiago') { ciudad = 'Santiago'; }

            const vendedorSeleccionado = document.getElementById('envioVendedor').value;
            
            const datosEnvio = [
                ['DE', 'SOC INV FUCAS SPA - RUT: 76.230.392-2'],
                ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                ['DIRECCI√ìN', 'AV LO ESPEJO 02360, SAN BERNARDO, SANTIAGO'],
                ['TEL√âFONO', '2 3347 5040'],
                ['SEPARADOR_1', ''],
                ['DESTINATARIO', campos.destinatario],
                ['RUT DESTINATARIO', campos.rut],
                ['TEL√âFONO DESTINO', campos.telefono],
                ['DIRECCI√ìN DESTINO', campos.direccion]
            ];
            
            if (referencia) {
                datosEnvio.push(['REFERENCIA', referencia]);
            }

            datosEnvio.push(
                ['COMUNA DESTINO', comunaCompleta],
                ['CIUDAD DESTINO', ciudad],
                ['REGI√ìN', region],
                ['SEPARADOR_2', ''],
                ['TIPO DE ENV√çO', document.getElementById('envioTipo').value],
                ['MEDIO DE TRANSPORTE', transporte],
                ['FORMA DE PAGO', document.getElementById('envioPago').value],
                ['NOTA DE VENTA', campos.notaVenta]
            );

            return {
                tipo: 'ENV√çO',
                bultos: parseInt(document.getElementById('envioBultos').value) || 1,
                datos: datosEnvio
            };
        }

        function procesarEnvio() {
            const datosEtiqueta = obtenerDatosEnvioDelFormulario();
            if (!datosEtiqueta) return;

            if (modoActual === 'multiple') {
                batchData.push(datosEtiqueta);
                renderizarLote();
                limpiarFormularioEnvio();
                alert(`‚úÖ Etiqueta para "${datosEtiqueta.datos.find(d=>d[0]==='DESTINATARIO')[1]}" agregada al lote.`);
            } else {
                processedData = datosEtiqueta;
                mostrarVistaPrevia();
            }
        }
        
        function procesarLote() {
            if (batchData.length === 0) {
                alert('No hay etiquetas en el lote para procesar.');
                return;
            }
            processedData = {
                tipo: 'ENVIO_LOTE',
                lote: batchData
            };
            generarVistaImprimible();
        }

        function mostrarVistaPrevia() {
            if (!processedData) return;
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('successMessage').classList.add('active');
            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = '';
            processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR')).forEach(fila => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight: 600;">${fila[0] || ''}</td><td>${fila[1] || ''}</td>`;
                tbody.appendChild(tr);
            });
        }
        
        function generarContenidoEtiquetaHTML(datosEtiqueta) {
            let contenidoEtiqueta = '';
            const esRetiro = datosEtiqueta.tipo === 'RETIRO';
            const esProvisoria = datosEtiqueta.tipo === 'PROVISORIA';

            if (esRetiro || esProvisoria) {
                let tituloEtiqueta = `<div class="titulo-etiqueta ${esProvisoria ? 'titulo-provisoria' : ''}">ETIQUETA ${datosEtiqueta.tipo}</div>`;
                let mainContent = '<div class="retiro-main">';
                datosEtiqueta.datos.filter(f => f[0] === 'CLIENTE' || f[0] === 'NOTA DE VENTA').forEach(fila => {
                    mainContent += `<p class="${fila[0].includes('NOTA') ? 'nota-venta' : ''}"><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                });
                mainContent += '</div>';
                let footerContent = `<div class="seccion-remitente">`;
                datosEtiqueta.datos.filter(f => f[0] === 'FECHA' || f[0] === 'VENDEDOR' || f[0] === 'OBSERVACIONES').forEach(fila => {
                    if(fila[1]) footerContent += `<p><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                });
                footerContent += '</div>';
                contenidoEtiqueta = `${tituloEtiqueta}${mainContent}${footerContent}`;
            } else { // Env√≠o
                let seccionRemitente = '<div class="seccion seccion-remitente">';
                let seccionDestinatario = '<div class="seccion seccion-destinatario">';
                let seccionEnvio = '<div class="seccion seccion-envio">';
                let currentSection = 'remitente';
                datosEtiqueta.datos.forEach(fila => {
                    if (fila[0].startsWith('SEPARADOR')) { currentSection = (currentSection === 'remitente') ? 'destinatario' : 'envio'; return; }
                    if (!fila[0] || !fila[1]) return;
                    let clase = fila[0].includes('NOTA DE VENTA') ? 'nota-venta' : '';
                    let linea = `<p class="${clase}"><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                    if (currentSection === 'remitente') seccionRemitente += linea;
                    else if (currentSection === 'destinatario') seccionDestinatario += linea;
                    else seccionEnvio += linea;
                });
                seccionRemitente += '</div>'; seccionDestinatario += '</div>'; seccionEnvio += '</div>';
                contenidoEtiqueta = `<div class="bulto-manual">BULTOS: ______ / ______</div>${seccionRemitente}<div class="separador"></div>${seccionDestinatario}<div class="separador"></div>${seccionEnvio}`;
            }
            return contenidoEtiqueta;
        }

        function generarVistaImprimible() {
            if (!processedData) { alert('Primero debes procesar los datos.'); return; }
            
            // L√≥gica para enviar datos a Sheets (se mantiene igual, se podr√≠a adaptar para lotes)
            // fetch(...);

            const printWindow = window.open('', '_blank');
            let content = `
                <html><head><title>Etiquetas para Imprimir</title><style>
                    body { margin: 0; font-family: sans-serif; }
                    .pagina { display: flex; flex-wrap: wrap; justify-content: space-around; align-content: flex-start; width: 21.59cm; height: 27.94cm; padding: 0.5cm; box-sizing: border-box; page-break-after: always; }
                    .etiqueta { display: flex; flex-direction: column; border: 1.5px dashed #777; padding: 6px 10px; box-sizing: border-box; line-height: 1.3; overflow-wrap: break-word; }
                    .etiqueta-envio { width: 49%; height: 48%; margin-bottom: 0.5cm; }
                    .etiqueta-retiro, .etiqueta-provisoria { width: 100%; height: 48%; margin-bottom: 2%; }
                    .titulo-etiqueta { text-align: center; font-weight: bold; font-size: 1.4em; margin-bottom: 5px; border-bottom: 1.5px solid #000; padding-bottom: 3px; }
                    .titulo-provisoria { background-color: #ffc; }
                    .bulto-manual { text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 5px; border-bottom: 1.5px solid #000; padding-bottom: 3px; }
                    .seccion p { margin: 1px 0; }
                    .seccion-remitente { font-size: 8pt; }
                    .seccion-destinatario { font-size: 11pt; flex-grow: 2; display: flex; flex-direction: column; justify-content: center; }
                    .seccion-destinatario p, .seccion-envio .nota-venta, .retiro-main { text-transform: uppercase; }
                    .seccion-envio { font-size: 11pt; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; }
                    .retiro-main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; font-size: 16pt; }
                    .campo { font-weight: bold; }
                    .separador { border-top: 1.5px solid #000; margin: 5px 0; }
                    .nota-venta { font-weight: bold; font-size: 18pt !important; }
                    @media print { .no-imprimir { display: none; } }
                </style></head><body>
                <div class="no-imprimir" style="text-align:center; padding:15px; background:#eee;">
                    <h2>Vista Previa de Impresi√≥n</h2><p>Usa la funci√≥n de imprimir (Ctrl+P) para generar las etiquetas.</p>
                    <button onclick="window.print()">Imprimir Ahora</button> <button onclick="window.close()">Cerrar</button>
                </div>`;
            
            let etiquetasHtml = '';
            
            if (processedData.tipo === 'ENVIO_LOTE') {
                processedData.lote.forEach((etiquetaData, index) => {
                    const contenidoEtiqueta = generarContenidoEtiquetaHTML(etiquetaData);
                    etiquetasHtml += `<div class="etiqueta etiqueta-envio">${contenidoEtiqueta}</div>`;

                    if ((index + 1) % 4 === 0 && (index + 1) < processedData.lote.length) {
                        etiquetasHtml += `</div><div class="pagina">`;
                    }
                });

            } else { // Modo individual
                for (let i = 1; i <= processedData.bultos; i++) {
                    const contenidoEtiqueta = generarContenidoEtiquetaHTML(processedData);
                    const esRetiro = processedData.tipo === 'RETIRO';
                    const esProvisoria = processedData.tipo === 'PROVISORIA';
                    let claseTipo = esRetiro ? 'etiqueta-retiro' : esProvisoria ? 'etiqueta-provisoria' : 'etiqueta-envio';
                    etiquetasHtml += `<div class="etiqueta ${claseTipo}">${contenidoEtiqueta}</div>`;
                    
                    const pageBreakTrigger = (esRetiro || esProvisoria) ? 2 : 4;
                    if (i % pageBreakTrigger === 0 && i < processedData.bultos) {
                        etiquetasHtml += `</div><div class="pagina">`;
                    }
                }
            }
            
            content += `<div class="pagina">${etiquetasHtml}</div></body></html>`;
            printWindow.document.write(content);
            printWindow.document.close();
        }

        function generarExcel() {
            if (!processedData || processedData.tipo === 'ENVIO_LOTE') { 
                alert('La exportaci√≥n a Excel solo est√° disponible en modo individual. Imprime el lote y luego genera cada Excel si es necesario.'); 
                return; 
            }
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            const datosBase = processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR'));
            for (let i = 1; i <= processedData.bultos; i++) {
                datosBase.forEach((rowData, rowIndex) => {
                    if (!ws_data[rowIndex]) ws_data[rowIndex] = [];
                    const startCol = (i - 1) * 3;
                    while (ws_data[rowIndex].length < startCol) ws_data[rowIndex].push(null);
                    ws_data[rowIndex].push(rowData[0], rowData[1]);
                });
            }
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const colWidths = [];
            for (let i = 0; i < processedData.bultos; i++) { colWidths.push({ wch: 35 }, { wch: 35 }, { wch: 5 }); }
            ws['!cols'] = colWidths;
            XLSX.utils.book_append_sheet(wb, ws, 'Etiquetas');
            const nombreCliente = (processedData.datos.find(d => d[0] === 'CLIENTE' || d[0] === 'DESTINATARIO')[1]).replace(/ /g, '_');
            XLSX.writeFile(wb, `Etiquetas_${nombreCliente}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        
        function copiarParaSheets() {
             if (!processedData || processedData.tipo === 'ENVIO_LOTE') { 
                alert('Esta funci√≥n solo est√° disponible en modo individual.'); 
                return; 
            }
            const sheet_data = [];
            const datosBase = processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR'));
            for (let i = 1; i <= processedData.bultos; i++) {
                datosBase.forEach((rowData, rowIndex) => {
                    if (!sheet_data[rowIndex]) sheet_data[rowIndex] = [];
                    const startCol = (i - 1) * 3;
                    while (sheet_data[rowIndex].length < startCol) sheet_data[rowIndex].push('');
                    sheet_data[rowIndex].push(rowData[0], rowData[1]);
                });
            }
            const tsvContent = sheet_data.map(row => row.join('\t')).join('\n');
            navigator.clipboard.writeText(tsvContent).then(() => {
                alert('Datos copiados en formato para Sheets. Abre una hoja de c√°lculo y pega los datos (Ctrl+V).');
            }).catch(err => console.error('Error:', err));
        }

        function mostrarDatosCopiables() {
            if (processedData.tipo === 'ENVIO_LOTE') { 
                alert('Esta funci√≥n solo est√° disponible en modo individual.'); 
                return; 
            }
            const copySection = document.getElementById('copySection');
            copySection.classList.toggle('hidden');
            if (!copySection.classList.contains('hidden')) {
                const textarea = document.getElementById('copyTextarea');
                textarea.value = processedData.datos.map(fila => `${fila[0]}: ${fila[1]}`).join('\n').trim();
            }
        }
        
        function copiarAlPortapapeles() {
            navigator.clipboard.writeText(document.getElementById('copyTextarea').value).then(() => alert('¬°Datos copiados!')).catch(err => console.error('Error:', err));
        }

        function volverInicio() { window.location.reload(); }
    </script>
</body>
</html>
```
