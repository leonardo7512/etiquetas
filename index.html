<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Etiquetas - FUCAS SPA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .type-selector, .form-section, .preview-section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .type-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .type-btn { padding: 15px 30px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 150px; text-align: center; }
        .type-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .type-btn:hover:not(.active) { border-color: #2563eb; background: #f8fafc; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #374151; }
        .form-group label.required::after { content: " *"; color: #ef4444; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        .btn-warning { background-color: #d97706; color: white; }
        .btn-warning:hover { background-color: #b45309; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .preview-section { display: none; }
        .preview-section.active { display: block; }
        .success-message { background-color: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.active { display: block; }
        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .copy-section { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .copy-textarea { width: 100%; height: 200px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px; background: white; resize: vertical; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .type-buttons, .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Procesador de Etiquetas - FUCAS SPA</h1><p>Sistema interactivo de generaci√≥n de etiquetas</p></div>
        <div class="type-selector">
            <h3 style="margin-bottom: 15px; text-align: center;">Selecciona el tipo de operaci√≥n:</h3>
            <div class="type-buttons">
                <button class="type-btn" onclick="seleccionarTipo('RETIRO', this)">üè™ RETIRO</button>
                <button class="type-btn" onclick="seleccionarTipo('ENVIO', this)">üì¶ ENV√çO</button>
                <button class="type-btn" onclick="seleccionarTipo('PROVISORIA', this)">‚è≥ PROVISORIA</button>
            </div>
        </div>

        <div id="formRETIRO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üìã Formulario de Retiro</h2>
            <div class="form-grid">
                <div class="form-group"><label for="retiroVendedor">Vendedor</label><select id="retiroVendedor"></select></div>
                <div class="form-group"><label for="retiroCliente" class="required">Cliente</label><input type="text" id="retiroCliente"></div>
                <div class="form-group"><label for="retiroNotaVenta" class="required">Nota de Venta</label><input type="text" id="retiroNotaVenta"></div>
                <div class="form-group"><label for="retiroBultos">Copias de Etiqueta</label><input type="number" id="retiroBultos" min="1" value="1"></div>
                <div class="form-group"><label for="retiroObservaciones">Observaciones</label><textarea id="retiroObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarRetiro()">Generar Vista Previa</button></div>
        </div>

        <div id="formPROVISORIA" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">‚è≥ Formulario de Etiqueta Provisoria</h2>
            <div class="form-grid">
                <div class="form-group"><label for="provisoriaVendedor">Vendedor</label><select id="provisoriaVendedor"></select></div>
                <div class="form-group"><label for="provisoriaCliente" class="required">Cliente</label><input type="text" id="provisoriaCliente"></div>
                <div class="form-group"><label for="provisoriaNotaVenta" class="required">Nota de Venta</label><input type="text" id="provisoriaNotaVenta"></div>
                <div class="form-group"><label for="provisoriaBultos">Copias de Etiqueta</label><input type="number" id="provisoriaBultos" min="1" value="1"></div>
                <div class="form-group"><label for="provisoriaObservaciones">Observaciones</label><textarea id="provisoriaObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarProvisoria()">Generar Vista Previa</button></div>
        </div>

        <div id="formENVIO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üì¶ Formulario de Env√≠o</h2>
            <div class="form-group"><label for="envioVendedor">Vendedor (Remitente)</label><select id="envioVendedor"></select></div>
            <h3 style="margin-bottom: 15px; color: #374151;">Datos del Destinatario</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioDestinatario" class="required">Destinatario</label><input type="text" id="envioDestinatario"></div>
                <div class="form-group"><label for="envioRut" class="required">RUT</label><input type="text" id="envioRut"></div>
                <div class="form-group"><label for="envioTelefono" class="required">Tel√©fono</label><input type="text" id="envioTelefono"></div>
                <div class="form-group"><label for="envioDireccion" class="required">Direcci√≥n</label><input type="text" id="envioDireccion"></div>
                <div class="form-group"><label for="envioComuna" class="required">Comuna</label><select id="envioComuna"><option value="">Seleccionar...</option></select></div>
                <div class="form-group"><label for="envioTipo">Tipo de Env√≠o</label><select id="envioTipo"><option value="Domicilio">Domicilio</option><option value="Oficina">Oficina</option></select></div>
            </div>
            <h3 style="margin: 25px 0 15px 0; color: #374151;">Datos del Env√≠o</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioNotaVenta" class="required">Nota de Venta</label><input type="text" id="envioNotaVenta"></div>
                <div class="form-group"><label for="envioBultos">Bultos (N¬∞ de etiquetas)</label><input type="number" id="envioBultos" min="1" value="1"></div>
                <div class="form-group"><label for="envioTransporte">Transporte</label><select id="envioTransporte"><option value="">Seleccionar...</option><option value="TUTTO PETS">TUTTO PETS</option><option value="JULIO MILLAN">JULIO MILLAN</option><option value="CHRISTIAN ALIAGA">CHRISTIAN ALIAGA</option><option value="Starken">Starken</option><option value="Chilexpress">Chilexpress</option><option value="Blue Express">Blue Express</option><option value="Correos de Chile">Correos de Chile</option><option value="Shipit">Shipit</option><option value="Shippify">Shippify</option><option value="VARMONTT">VARMONTT</option><option value="PULLMAN">PULLMAN</option><option value="CACEM">CACEM</option><option value="MERCOSUR">MERCOSUR</option><option value="TVP">TVP</option><option value="Otro">Otro</option></select></div>
                <div class="form-group hidden" id="transporteOtroGroup"><label for="envioTransporteOtro">Especificar Transporte</label><input type="text" id="envioTransporteOtro"></div>
                <div class="form-group"><label for="envioPago">Pago</label><select id="envioPago"><option value="">Seleccionar...</option><option value="Pagado">Pagado</option><option value="Por Pagar">Por Pagar</option><option value="Contra Entrega">Contra Entrega</option></select></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarEnvio()">Generar Vista Previa</button></div>
        </div>

        <div id="previewSection" class="preview-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üëÄ Vista Previa</h2>
            <div id="successMessage" class="success-message"><strong>‚úÖ Datos correctos.</strong><p>Usa las opciones de abajo para imprimir o exportar.</p></div>
            <div class="table-container"><table><tbody id="previewTable"></tbody></table></div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="generarVistaImprimible()">üñ®Ô∏è Imprimir Etiquetas</button>
                <button class="btn btn-success" onclick="generarExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-success" onclick="copiarParaSheets()">üìã Copiar para Sheets</button>
                <button class="btn btn-warning" onclick="mostrarDatosCopiables()">üìù Copiar Datos</button>
                <button class="btn btn-secondary" onclick="volverInicio()">üîÑ Nuevo</button>
            </div>
            <div id="copySection" class="copy-section hidden">
                <h3 style="margin-bottom: 15px;">üìã Datos para Copiar</h3>
                <textarea id="copyTextarea" class="copy-textarea" readonly></textarea>
                <div style="margin-top: 10px; text-align: center;"><button class="btn btn-warning" onclick="copiarAlPortapapeles()">Copiar</button></div>
            </div>
        </div>
    </div>

    <script>
        let processedData = null;
        const vendedores = { "LEONARDO CASTRO": "2 3347 5040", "ANDREA FUENTES": "+56 9 6863 7136", "JOSELYN GOMEZ GOMEZ": "+56 9 3096 8640", "YEIMY REALPE": "+56 9 8544 9261", "LESLIE RIOS": "+56 9 3457 2139" };
        const comunasPorRegion = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"], "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"], "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"], "Libertador General Bernardo O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "√ëuble": ["Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Quirihue", "R√°nquil", "Treguaco", "Bulnes", "Chill√°n Viejo", "Chill√°n", "El Carmen", "Pemuco", "Pinto", "Quill√≥n", "San Ignacio", "Yungay", "Coihueco", "√ëiqu√©n", "San Carlos", "San Fabi√°n", "San Nicol√°s"], "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"], "La Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"], "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"], "Ays√©n del General Carlos Ib√°√±ez del Campo": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"], "Magallanes y de la Ant√°rtica Chilena": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"] };
        
        function poblarSelect(selectId, data, useKeysAsValue = true) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            for (const key in data) {
                const option = document.createElement('option');
                option.value = useKeysAsValue ? key : data[key];
                option.textContent = key;
                select.appendChild(option);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selectComuna = document.getElementById('envioComuna');
            selectComuna.innerHTML = '<option value="">Seleccionar...</option>';
            for (const region in comunasPorRegion) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = region;
                comunasPorRegion[region].forEach(comuna => {
                    const option = document.createElement('option');
                    option.value = comuna;
                    option.textContent = comuna;
                    optgroup.appendChild(option);
                });
                selectComuna.appendChild(optgroup);
            }
            poblarSelect('retiroVendedor', vendedores, true);
            poblarSelect('provisoriaVendedor', vendedores, true);
            poblarSelect('envioVendedor', vendedores, true);

            document.getElementById('envioTransporte').addEventListener('change', function() {
                const pagoSelect = document.getElementById('envioPago');
                document.getElementById('transporteOtroGroup').classList.toggle('hidden', this.value !== 'Otro');
                pagoSelect.disabled = false;
                if (this.value === 'TUTTO PETS') {
                    pagoSelect.value = 'Pagado';
                    pagoSelect.disabled = true;
                    alert('ATENCI√ìN: Env√≠o por TUTTO PETS debe ser PAGADO y cobrado en la nota de venta.');
                } else if (this.value === 'JULIO MILLAN' || this.value === 'CHRISTIAN ALIAGA') {
                    const courierName = this.value;
                    alert(`INFO: Para env√≠os con ${courierName}, si seleccionas "Por Pagar", el cobro lo gestiona directamente √©l.`);
                }
            });
        });

        function seleccionarTipo(tipo, element) {
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.form-section, #previewSection').forEach(s => s.classList.remove('active'));
            document.getElementById(`form${tipo}`).classList.add('active');
        }
        
        function procesarRetiro() {
            const cliente = document.getElementById('retiroCliente').value.trim();
            const notaVenta = document.getElementById('retiroNotaVenta').value.trim();
            if (!cliente || !notaVenta) {
                alert('Los campos Cliente y Nota de Venta son obligatorios.');
                return;
            }
            const vendedorSeleccionado = document.getElementById('retiroVendedor').value;
            const fecha = new Date();
            processedData = {
                tipo: 'RETIRO',
                bultos: parseInt(document.getElementById('retiroBultos').value) || 1,
                datos: [
                    ['CLIENTE', cliente],
                    ['NOTA DE VENTA', notaVenta],
                    ['FECHA', `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`],
                    ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                    ['OBSERVACIONES', document.getElementById('retiroObservaciones').value.trim()]
                ]
            };
            mostrarVistaPrevia();
        }

        function procesarProvisoria() {
            const cliente = document.getElementById('provisoriaCliente').value.trim();
            const notaVenta = document.getElementById('provisoriaNotaVenta').value.trim();
            if (!cliente || !notaVenta) {
                alert('Los campos Cliente y Nota de Venta son obligatorios.');
                return;
            }
            const vendedorSeleccionado = document.getElementById('provisoriaVendedor').value;
            const fecha = new Date();
            processedData = {
                tipo: 'PROVISORIA',
                bultos: parseInt(document.getElementById('provisoriaBultos').value) || 1,
                datos: [
                    ['CLIENTE', cliente],
                    ['NOTA DE VENTA', notaVenta],
                    ['FECHA', `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`],
                    ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                    ['OBSERVACIONES', document.getElementById('provisoriaObservaciones').value.trim()]
                ]
            };
            mostrarVistaPrevia();
        }

        function procesarEnvio() {
            const campos = { destinatario: document.getElementById('envioDestinatario').value.trim(), rut: document.getElementById('envioRut').value.trim(), telefono: document.getElementById('envioTelefono').value.trim(), direccion: document.getElementById('envioDireccion').value.trim(), comuna: document.getElementById('envioComuna').value, notaVenta: document.getElementById('envioNotaVenta').value.trim() };
            const faltantes = Object.keys(campos).filter(k => !campos[k]);
            if (faltantes.length > 0) { alert(`Faltan campos obligatorios: ${faltantes.join(', ')}`); return; }
            let transporte = document.getElementById('envioTransporte').value;
            if (transporte === 'Otro') { transporte = document.getElementById('envioTransporteOtro').value.trim() || 'Otro (sin especificar)'; }
            let region = 'No encontrada';
            for (const r in comunasPorRegion) { if (comunasPorRegion[r].includes(campos.comuna)) { region = r; break; } }
            let ciudad = campos.comuna;
            if (region === 'Metropolitana de Santiago') { ciudad = 'Santiago'; }
            const vendedorSeleccionado = document.getElementById('envioVendedor').value;
            processedData = {
                tipo: 'ENV√çO',
                bultos: parseInt(document.getElementById('envioBultos').value) || 1,
                datos: [
                    ['DE', 'SOC INV FUCAS SPA - RUT: 76.230.392-2'],
                    ['VENDEDOR', `${vendedorSeleccionado} - ${vendedores[vendedorSeleccionado]}`],
                    ['DIRECCI√ìN', 'AV LO ESPEJO 02360, SAN BERNARDO, SANTIAGO'],
                    ['TEL√âFONO', '2 3347 5040'],
                    ['SEPARADOR_1', ''],
                    ['DESTINATARIO', campos.destinatario],
                    ['RUT DESTINATARIO', campos.rut],
                    ['TEL√âFONO DESTINO', campos.telefono],
                    ['DIRECCI√ìN DESTINO', campos.direccion],
                    ['COMUNA DESTINO', campos.comuna],
                    ['CIUDAD DESTINO', ciudad],
                    ['REGI√ìN', region],
                    ['SEPARADOR_2', ''],
                    ['TIPO DE ENV√çO', document.getElementById('envioTipo').value],
                    ['MEDIO DE TRANSPORTE', transporte],
                    ['FORMA DE PAGO', document.getElementById('envioPago').value],
                    ['NOTA DE VENTA', campos.notaVenta]
                ]
            };
            mostrarVistaPrevia();
        }

        function mostrarVistaPrevia() {
            if (!processedData) return;
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('successMessage').classList.add('active');
            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = '';
            processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR') && !fila[0].startsWith('*****')).forEach(fila => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight: 600;">${fila[0] || ''}</td><td>${fila[1] || ''}</td>`;
                tbody.appendChild(tr);
            });
        }

        function generarVistaImprimible() {
            if (!processedData) { alert('Primero debes procesar los datos.'); return; }

            // --- INICIO DE LA INTEGRACI√ìN CON GOOGLE SHEETS ---
            // ¬°URL YA CONFIGURADA! Esta es la direcci√≥n de tu script.
            const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwI0zeKjgJybIunwJ4SYnIHqYxenypLJ1uqlIoIZHJs6Q9nwiot8resIXZ5l99md3_r/exec";

            const datosParaSheet = {
                tipo: processedData.tipo,
                bultos: processedData.bultos,
                vendedor: processedData.datos.find(d => d[0] === 'VENDEDOR')?. [1] || '',
                notaVenta: processedData.datos.find(d => d[0].toUpperCase() === 'NOTA DE VENTA')?. [1] || '',
                cliente: (processedData.datos.find(d => d[0] === 'CLIENTE') || processedData.datos.find(d => d[0] === 'DESTINATARIO'))?. [1] || '',
                rut: processedData.datos.find(d => d[0] === 'RUT DESTINATARIO')?. [1] || '',
                telefono: processedData.datos.find(d => d[0] === 'TEL√âFONO DESTINO')?. [1] || '',
                direccion: processedData.datos.find(d => d[0] === 'DIRECCI√ìN DESTINO')?. [1] || '',
                comuna: processedData.datos.find(d => d[0] === 'COMUNA DESTINO')?. [1] || '',
                transporte: processedData.datos.find(d => d[0] === 'MEDIO DE TRANSPORTE')?. [1] || '',
                pago: processedData.datos.find(d => d[0] === 'FORMA DE PAGO')?. [1] || '',
                observaciones: processedData.datos.find(d => d[0] === 'OBSERVACIONES')?. [1] || ''
            };

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosParaSheet)
            })
            .then(res => console.log("Solicitud de guardado enviada a Sheets."))
            .catch(error => console.error('Error al enviar datos a Sheets:', error));
            // --- FIN DE LA INTEGRACI√ìN ---

            const printWindow = window.open('', '_blank');
            const esRetiro = processedData.tipo === 'RETIRO';
            const esProvisoria = processedData.tipo === 'PROVISORIA';
            let content = `
                <html><head><title>Etiquetas para Imprimir</title><style>
                    body { margin: 0; font-family: sans-serif; }
                    .pagina { display: flex; flex-wrap: wrap; justify-content: space-around; align-content: flex-start; width: 21.59cm; height: 27.94cm; padding: 0.5cm; box-sizing: border-box; page-break-after: always; }
                    .etiqueta { display: flex; flex-direction: column; border: 1.5px dashed #777; padding: 6px 10px; box-sizing: border-box; line-height: 1.4; overflow-wrap: break-word; }
                    .etiqueta-envio { width: 49%; height: 48%; margin-bottom: 0.5cm; }
                    .etiqueta-retiro, .etiqueta-provisoria { width: 100%; height: 48%; margin-bottom: 2%; }
                    .titulo-etiqueta { text-align: center; font-weight: bold; font-size: 1.4em; margin-bottom: 5px; border-bottom: 1.5px solid #000; padding-bottom: 3px; }
                    .titulo-provisoria { background-color: #ffc; }
                    .bulto-manual { text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 5px; border-bottom: 1.5px solid #000; padding-bottom: 3px; }
                    .seccion p { margin: 1px 0; }
                    .seccion-remitente { font-size: 8pt; }
                    .seccion-destinatario { font-size: 12pt; flex-grow: 2; display: flex; flex-direction: column; justify-content: center; }
                    .seccion-destinatario p, .seccion-envio .nota-venta, .retiro-main { text-transform: uppercase; }
                    .seccion-envio { font-size: 12pt; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; }
                    .retiro-main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; font-size: 16pt; }
                    .campo { font-weight: bold; }
                    .separador { border-top: 1.5px solid #000; margin: 5px 0; }
                    .nota-venta { font-weight: bold; font-size: 18pt !important; }
                    @media print { .no-imprimir { display: none; } }
                </style></head><body>
                <div class="no-imprimir" style="text-align:center; padding:15px; background:#eee;">
                    <h2>Vista Previa de Impresi√≥n</h2><p>Usa la funci√≥n de imprimir (Ctrl+P) para generar las etiquetas.</p>
                    <button onclick="window.print()">Imprimir Ahora</button> <button onclick="window.close()">Cerrar</button>
                </div>`;
            
            let etiquetasHtml = '';
            for (let i = 1; i <= processedData.bultos; i++) {
                let contenidoEtiqueta = '';
                let tituloEtiqueta = '';

                if (esRetiro) {
                    tituloEtiqueta = '<div class="titulo-etiqueta">ETIQUETA RETIRO</div>';
                } else if (esProvisoria) {
                    tituloEtiqueta = '<div class="titulo-etiqueta titulo-provisoria">ETIQUETA PROVISORIA</div>';
                }

                if (esRetiro || esProvisoria) {
                    let mainContent = '<div class="retiro-main">';
                    processedData.datos.filter(f => f[0] === 'CLIENTE' || f[0] === 'NOTA DE VENTA').forEach(fila => {
                         mainContent += `<p class="${fila[0].includes('NOTA') ? 'nota-venta' : ''}"><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                    });
                    mainContent += '</div>';
                    let footerContent = `<div class="seccion-remitente">`;
                    processedData.datos.filter(f => f[0] === 'FECHA' || f[0] === 'VENDEDOR' || f[0] === 'OBSERVACIONES').forEach(fila => {
                        if(fila[1]) footerContent += `<p><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                    });
                    footerContent += '</div>';
                    contenidoEtiqueta = `${tituloEtiqueta}${mainContent}${footerContent}`;
                } else { // Env√≠o
                    let seccionRemitente = '<div class="seccion seccion-remitente">';
                    let seccionDestinatario = '<div class="seccion seccion-destinatario">';
                    let seccionEnvio = '<div class="seccion seccion-envio">';
                    let currentSection = 'remitente';
                    processedData.datos.forEach(fila => {
                        if (fila[0].startsWith('SEPARADOR')) { currentSection = (currentSection === 'remitente') ? 'destinatario' : 'envio'; return; }
                        if (!fila[0] || !fila[1]) return;
                        let clase = fila[0].includes('NOTA DE VENTA') ? 'nota-venta' : '';
                        let linea = `<p class="${clase}"><span class="campo">${fila[0]}:</span> ${fila[1]}</p>`;
                        if (currentSection === 'remitente') seccionRemitente += linea;
                        else if (currentSection === 'destinatario') seccionDestinatario += linea;
                        else seccionEnvio += linea;
                    });
                    seccionRemitente += '</div>'; seccionDestinatario += '</div>'; seccionEnvio += '</div>';
                    contenidoEtiqueta = `<div class="bulto-manual">BULTOS: ______ / ______</div>${seccionRemitente}<div class="separador"></div>${seccionDestinatario}<div class="separador"></div>${seccionEnvio}`;
                }
                
                let claseTipo = esRetiro ? 'etiqueta-retiro' : esProvisoria ? 'etiqueta-provisoria' : 'etiqueta-envio';
                etiquetasHtml += `<div class="etiqueta ${claseTipo}">${contenidoEtiqueta}</div>`;
                
                const pageBreakTrigger = (esRetiro || esProvisoria) ? 2 : 4;
                if (i % pageBreakTrigger === 0 && i < processedData.bultos) { etiquetasHtml += `</div><div class="pagina">`; }
            }
            content += `<div class="pagina">${etiquetasHtml}</div></body></html>`;
            printWindow.document.write(content);
            printWindow.document.close();
        }

        function generarExcel() {
            if (!processedData) { alert('Primero debes procesar los datos.'); return; }
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            const datosBase = processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR') && !fila[0].startsWith('*****'));
            for (let i = 1; i <= processedData.bultos; i++) {
                datosBase.forEach((rowData, rowIndex) => {
                    if (!ws_data[rowIndex]) ws_data[rowIndex] = [];
                    const startCol = (i - 1) * 3;
                    while (ws_data[rowIndex].length < startCol) ws_data[rowIndex].push(null);
                    ws_data[rowIndex].push(rowData[0], rowData[1]);
                });
            }
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const colWidths = [];
            for (let i = 0; i < processedData.bultos; i++) { colWidths.push({ wch: 35 }, { wch: 35 }, { wch: 5 }); }
            ws['!cols'] = colWidths;
            XLSX.utils.book_append_sheet(wb, ws, 'Etiquetas');
            const nombreCliente = (processedData.datos.find(d => d[0] === 'CLIENTE' || d[0] === 'DESTINATARIO')[1]).replace(/ /g, '_');
            XLSX.writeFile(wb, `Etiquetas_${nombreCliente}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        
        function copiarParaSheets() {
            if (!processedData) { alert('Primero debes procesar los datos.'); return; }
            const sheet_data = [];
            const datosBase = processedData.datos.filter(fila => !fila[0].startsWith('SEPARADOR') && !fila[0].startsWith('*****'));
            for (let i = 1; i <= processedData.bultos; i++) {
                datosBase.forEach((rowData, rowIndex) => {
                    if (!sheet_data[rowIndex]) sheet_data[rowIndex] = [];
                    const startCol = (i - 1) * 3;
                    while (sheet_data[rowIndex].length < startCol) sheet_data[rowIndex].push('');
                    sheet_data[rowIndex].push(rowData[0], rowData[1]);
                });
            }
            const tsvContent = sheet_data.map(row => row.join('\t')).join('\n');
            navigator.clipboard.writeText(tsvContent).then(() => {
                alert('Datos copiados en formato para Sheets. Abre una hoja de c√°lculo y pega los datos (Ctrl+V).');
            }).catch(err => console.error('Error:', err));
        }

        function mostrarDatosCopiables() {
            const copySection = document.getElementById('copySection');
            copySection.classList.toggle('hidden');
            if (!copySection.classList.contains('hidden')) {
                const textarea = document.getElementById('copyTextarea');
                textarea.value = processedData.datos.map(fila => `${fila[0]}: ${fila[1]}`).join('\n').trim();
            }
        }
        
        function copiarAlPortapapeles() {
            navigator.clipboard.writeText(document.getElementById('copyTextarea').value).then(() => alert('¬°Datos copiados!')).catch(err => console.error('Error:', err));
        }

        function volverInicio() { window.location.reload(); }
    </script>
</body>
</html>
