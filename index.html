<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Etiquetas - FUCAS SPA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .selector-section, .form-section, .preview-section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button-group-flex { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .flex-btn { padding: 15px 30px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 150px; text-align: center; }
        .flex-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .flex-btn:hover:not(.active) { border-color: #2563eb; background: #f8fafc; }
        
        .paste-btn { background: #8b5cf6 !important; color: white !important; border-color: #7c3aed !important; }
        .paste-btn:hover { background: #7c3aed !important; }

        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #374151; }
        .form-group label.required::after { content: " *"; color: #ef4444; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #d97706; color: white; }
        .btn-warning:hover { background-color: #b45309; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .preview-section { display: none; }
        .preview-section.active { display: block; }
        .success-message { background-color: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.active { display: block; }
        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .copy-section { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .copy-textarea { width: 100%; height: 200px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 12px; background: white; resize: vertical; }
        .hidden { display: none !important; }
        .modal-importar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { position: relative; background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #888; }
        .modal-close:hover { color: #333; }
        .upload-mini { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc; }
        .upload-mini input[type="file"] { display: none; }
        .upload-mini label { cursor: pointer; display: inline-block; }
        #batchSection { display: none; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-top: 25px; }
        .batch-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; }
        .batch-item-info { font-size: 14px; }
        .batch-item-info strong { color: #1d4ed8; }

        .switch-container { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 15px; 
            background: #fef3c7; 
            border: 2px solid #f59e0b; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 34px; 
        }
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 34px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 26px; 
            width: 26px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { 
            background-color: #f59e0b; 
        }
        input:checked + .slider:before { 
            transform: translateX(26px); 
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .button-group-flex, .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Procesador de Etiquetas - FUCAS SPA</h1><p>Sistema interactivo de generaci√≥n de etiquetas</p></div>
        
        <div class="selector-section">
            <h3 style="margin-bottom: 15px; text-align: center;">1. Selecciona el tipo de operaci√≥n:</h3>
            <div class="button-group-flex">
                <button class="flex-btn" onclick="seleccionarTipo('RETIRO', this)">üè™ RETIRO</button>
                <button class="flex-btn" onclick="seleccionarTipo('ENVIO', this)">üì¶ ENV√çO</button>
                <button class="flex-btn" onclick="seleccionarTipo('PROVISORIA', this)">‚è≥ PROVISORIA</button>
                <button class="flex-btn paste-btn" onclick="abrirModalPegar()">üì• Pegar Datos</button>
            </div>
        </div>

        <div id="modoSelectorSection" class="selector-section hidden">
            <h3 style="margin-bottom: 15px; text-align: center;">2. Selecciona el modo de trabajo:</h3>
            <div class="button-group-flex">
                <button class="flex-btn" onclick="seleccionarModo('individual', this)">üë§ Modo Individual</button>
                <button class="flex-btn" onclick="seleccionarModo('multiple', this)">üìë Modo M√∫ltiple</button>
            </div>
        </div>

        <div id="formRETIRO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üìã Formulario de Retiro</h2>
            <div class="form-grid">
                <div class="form-group"><label for="retiroVendedor">Vendedor</label><select id="retiroVendedor"></select></div>
                <div class="form-group"><label for="retiroCliente" class="required">Cliente</label><input type="text" id="retiroCliente"></div>
                <div class="form-group"><label for="retiroNotaVenta" class="required">Nota de Venta</label><input type="text" id="retiroNotaVenta"></div>
                <div class="form-group"><label for="retiroBultos">Copias de Etiqueta</label><input type="number" id="retiroBultos" min="1" value="1"></div>
                <div class="form-group"><label for="retiroContacto">Contacto (Opcional)</label><input type="text" id="retiroContacto" placeholder="Nombre de contacto"></div>
                <div class="form-group"><label for="retiraQuien">Retira (Opcional)</label><input type="text" id="retiraQuien" placeholder="Quien retira"></div>
                <div class="form-group"><label for="retiroObservaciones">Observaciones</label><textarea id="retiroObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarRetiro()">Generar Vista Previa</button></div>
        </div>

        <div id="formPROVISORIA" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">‚è≥ Formulario de Etiqueta Provisoria</h2>
            <div class="form-grid">
                <div class="form-group"><label for="provisoriaVendedor">Vendedor</label><select id="provisoriaVendedor"></select></div>
                <div class="form-group"><label for="provisoriaCliente" class="required">Cliente</label><input type="text" id="provisoriaCliente"></div>
                <div class="form-group"><label for="provisoriaNotaVenta" class="required">Nota de Venta</label><input type="text" id="provisoriaNotaVenta"></div>
                <div class="form-group"><label for="provisoriaBultos">Copias de Etiqueta</label><input type="number" id="provisoriaBultos" min="1" value="1"></div>
                <div class="form-group"><label for="provisoriaObservaciones">Observaciones</label><textarea id="provisoriaObservaciones"></textarea></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="procesarProvisoria()">Generar Vista Previa</button></div>
        </div>

        <div id="formENVIO" class="form-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üì¶ Formulario de Env√≠o</h2>
            
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="switchPagaAromaker">
                    <span class="slider"></span>
                </label>
                <label for="switchPagaAromaker" style="font-weight: 600; color: #b45309; cursor: pointer;">
                    üí∞ Marcar como "PAGA AROMAKER"
                </label>
            </div>

            <div class="form-group"><label for="envioVendedor">Vendedor (Remitente)</label><select id="envioVendedor"></select></div>
            <h3 style="margin-bottom: 15px; color: #374151;">Datos del Destinatario</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioDestinatario" class="required">Destinatario</label><input type="text" id="envioDestinatario"></div>
                <div class="form-group">    
                    <label for="envioRut" class="required">RUT</label>    
                    <input type="text" id="envioRut" onblur="buscarClientePorRut()">    
                    <button type="button" class="btn btn-warning" onclick="mostrarImportarCliente()" style="margin-top: 5px; font-size: 12px;">
                        üìÇ Importar desde Excel
                    </button>
                </div>
                <div class="form-group"><label for="envioTelefono" class="required">Tel√©fono</label><input type="text" id="envioTelefono"></div>
                <div class="form-group"><label for="envioDireccion" class="required">Direcci√≥n</label><input type="text" id="envioDireccion"></div>
                <div class="form-group"><label for="envioReferencia">Referencia (Opcional)</label><input type="text" id="envioReferencia" placeholder="Ej: Casa rejas verdes, al lado de..."></div>
                <div class="form-group">
                    <label for="envioComuna" class="required">Comuna</label>
                    <input type="text" id="envioComuna" list="comunasList" placeholder="Escribe para buscar...">
                    <datalist id="comunasList"></datalist>
                </div>
                <div class="form-group"><label for="envioTipo">Tipo de Env√≠o</label><select id="envioTipo"><option value="Domicilio">Domicilio</option><option value="Oficina">Oficina</option></select></div>
            </div>
            <h3 style="margin: 25px 0 15px 0; color: #374151;">Datos del Env√≠o</h3>
            <div class="form-grid">
                <div class="form-group"><label for="envioNotaVenta" class="required">Nota de Venta</label><input type="text" id="envioNotaVenta"></div>
                <div class="form-group"><label for="envioBultos">Bultos (N¬∞ de etiquetas)</label><input type="number" id="envioBultos" min="1" value="1"></div>
                <div class="form-group"><label for="envioTransporte">Transporte</label><select id="envioTransporte"><option value="">Seleccionar...</option><option value="TUTTO PETS">TUTTO PETS</option><option value="JULIO MILLAN">JULIO MILLAN</option><option value="CHRISTIAN ALIAGA">CHRISTIAN ALIAGA</option><option value="Starken">Starken</option><option value="Chilexpress">Chilexpress</option><option value="Blue Express">Blue Express</option><option value="Correos de Chile">Correos de Chile</option><option value="Shipit">Shipit</option><option value="Shippify">Shippify</option><option value="VARMONTT">VARMONTT</option><option value="PULLMAN">PULLMAN</option><option value="CACEM">CACEM</option><option value="MERCOSUR">MERCOSUR</option><option value="TVP">TVP</option><option value="Otro">Otro</option></select></div>
                <div class="form-group hidden" id="transporteOtroGroup"><label for="envioTransporteOtro">Especificar Transporte</label><input type="text" id="envioTransporteOtro"></div>
                <div class="form-group"><label for="envioPago">Pago</label><select id="envioPago"><option value="">Seleccionar...</option><option value="Pagado">Pagado</option><option value="Por Pagar">Por Pagar</option><option value="Contra Entrega">Contra Entrega</option></select></div>
            </div>
            <div id="envioBtnGroup" class="btn-group">
                <button id="btnProcesarEnvio" class="btn btn-primary" onclick="procesarEnvio()">Generar Vista Previa</button>
            </div>
        </div>
        
        <div id="batchSection">
            <h3 style="margin-bottom: 15px; color: #374151;">üìã Lote de Etiquetas Agregadas (<span id="batchCount">0 Entradas / 0 Etiquetas</span>)</h3>
            <ul id="batchList" class="batch-list"></ul>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="procesarLote()">üñ®Ô∏è Procesar Lote e Imprimir</button>
            </div>
        </div>
        
        <div id="modalImportarCliente" class="modal-importar" style="display: none;" onclick="cerrarModalSiEsAfuera(event)">
            <div class="modal-content">
                <span class="modal-close" onclick="cerrarImportarCliente()">√ó</span>
                <h3>üìÇ Importar Cliente desde Excel</h3>
                <p>Sube un archivo Excel de etiquetas previas para cargar autom√°ticamente los datos del cliente.</p>
                <div class="upload-mini" style="margin-top: 15px;">
                    <input type="file" id="fileImportCliente" accept=".xlsx,.xls" onchange="procesarArchivoImportado(event)">
                    <label for="fileImportCliente" class="btn btn-primary">Seleccionar Archivo Excel</label>
                </div>
                <div id="resultadoImportacion" style="margin-top: 15px; display: none;">
                    <div id="datosImportados"></div>
                    <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                        <button class="btn btn-success" onclick="aplicarDatosImportados()">‚úÖ Usar estos datos</button>
                        <button class="btn btn-secondary" onclick="cerrarImportarCliente()">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modalPegarDatos" class="modal-importar" style="display: none;">
            <div class="modal-content">
                <span class="modal-close" onclick="cerrarModalPegar()">√ó</span>
                <h3>üìã Pegar Datos Copiados</h3>
                <p style="margin-bottom: 10px; font-size: 13px; color: #666;">Pega aqu√≠ el texto copiado de una etiqueta anterior (con formato: DESTINATARIO: ..., RUT: ..., etc).</p>
                <textarea id="textoPegado" class="copy-textarea" placeholder="Pega el texto aqu√≠..."></textarea>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-secondary" onclick="cerrarModalPegar()">Cancelar</button>
                    <button class="btn btn-success" onclick="procesarTextoPegado()">‚úÖ Cargar Datos</button>
                </div>
            </div>
        </div>

        <div id="previewSection" class="preview-section">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üëÄ Vista Previa</h2>
            <div id="successMessage" class="success-message"><strong>‚úÖ Datos correctos.</strong><p>Usa las opciones de abajo para imprimir o exportar.</p></div>
            <div class="table-container"><table><tbody id="previewTable"></tbody></table></div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="generarVistaImprimible()">üñ®Ô∏è Imprimir Etiquetas</button>
                <button class="btn btn-success" onclick="generarExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-success" onclick="copiarParaSheets()">üìã Copiar para Sheets</button>
                <button class="btn btn-warning" onclick="mostrarDatosCopiables()">üìù Copiar Datos</button>
                <button class="btn btn-secondary" onclick="volverInicio()">üîÑ Nuevo</button>
            </div>
            <div id="copySection" class="copy-section hidden">
                <h3 style="margin-bottom: 15px;">üìã Datos para Copiar</h3>
                <textarea id="copyTextarea" class="copy-textarea" readonly></textarea>
                <div style="margin-top: 10px; text-align: center;"><button class="btn btn-warning" onclick="copiarAlPortapapeles()">Copiar</button></div>
            </div>
        </div>
    </div>

    <script>
        let processedData = null;
        let batchData = [];
        let modoActual = 'individual';
        let pagaAromakerActivo = false;
        
        const vendedores = { "LEONARDO CASTRO": "2 3347 5040", "ANDREA FUENTES": "+56 9 6863 7136", "JOSELYN GOMEZ": "+56 9 3096 8640", "YEIMY REALPE": "+56 9 8544 9261", "LESLIE RIOS": "+56 9 3457 2139", "ADM": "+56 9 4755 4045" };
        const comunasPorRegion = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"], "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"], "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±al√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"], "Libertador General Bernardo O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "√ëuble": ["Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Quirihue", "R√°nquil", "Treguaco", "Bulnes", "Chill√°n Viejo", "Chill√°n", "El Carmen", "Pemuco", "Pinto", "Quill√≥n", "San Ignacio", "Yungay", "Coihueco", "√ëiqu√©n", "San Carlos", "San Fabi√°n", "San Nicol√°s"], "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"], "La Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"], "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"], "Ays√©n del General Carlos Ib√°√±ez del Campo": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"], "Magallanes y de la Ant√°rtica Chilena": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"] };
        
        const googleScriptURL = 'https://script.google.com/macros/s/AKfycbwEIehhRdV6jDI9lDGCQEgUaRh13kTZDdBUO4Oc7Ph8I5FY1yJ7zx53fqmXNqs9DMF4tA/exec';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('switchPagaAromaker').addEventListener('change', function() {
                pagaAromakerActivo = this.checked;
            });
        });

        function obtenerValor(datos, clave) {
            const campo = datos.find(d => d[0].toUpperCase().trim() === clave.toUpperCase().trim());
            return campo ? campo[1] : '';
        }

        function enviarAGoogleSheets(data) {
            const etiquetasAEnviar = data.lote ? data.lote : [data];
            if (etiquetasAEnviar.length === 0) return;

            etiquetasAEnviar.forEach(etiqueta => {
                const vendedorCompleto = obtenerValor(etiqueta.datos, 'VENDEDOR');
                const nombreVendedorLimpio = vendedorCompleto.split(' - ')[0].trim();

                const payload = {
                    sheet_name: nombreVendedorLimpio,
                    ultima_actualizacion: new Date().toLocaleString("es-CL", { timeZone: "America/Santiago" }),
                    nota_venta: obtenerValor(etiqueta.datos, 'NOTA DE VENTA'),
                    estado: 'Creado',
                    tipo_operacion: etiqueta.tipo,
                    vendedor: vendedorCompleto,
                    cliente_destinatario: obtenerValor(etiqueta.datos, 'CLIENTE') || obtenerValor(etiqueta.datos, 'DESTINATARIO'),
                    rut: obtenerValor(etiqueta.datos, 'RUT DESTINATARIO'),
                    telefono: obtenerValor(etiqueta.datos, 'TEL√âFONO DESTINO') || obtenerValor(etiqueta.datos, 'TEL√âFONO'),
                    direccion: obtenerValor(etiqueta.datos, 'DIRECCI√ìN DESTINO') || obtenerValor(etiqueta.datos, 'DIRECCI√ìN'),
                    comuna: obtenerValor(etiqueta.datos, 'COMUNA DESTINO'),
                    transporte: obtenerValor(etiqueta.datos, 'MEDIO DE TRANSPORTE'),
                    pago_envio: obtenerValor(etiqueta.datos, 'FORMA DE PAGO'),
                    bultos: etiqueta.bultos,
                    observaciones: obtenerValor(etiqueta.datos, 'OBSERVACIONES')
                };

                const formData = new FormData();
                for (const key in payload) {
                    formData.append(key, payload[key] || '');
                }
                
                fetch(googleScriptURL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                })
                .then(response => console.log(`‚úÖ Datos enviados a la hoja "${nombreVendedorLimpio}"`))
                .catch(error => console.error('‚ùå Error al enviar a Google Sheets:', error));
            });
        }
        
        let datosClienteImportado = null;
        function mostrarImportarCliente() { document.getElementById('modalImportarCliente').style.display = 'flex'; }
        function cerrarImportarCliente() {
            document.getElementById('modalImportarCliente').style.display = 'none';
            document.getElementById('resultadoImportacion').style.display = 'none';
            document.getElementById('fileImportCliente').value = '';
            datosClienteImportado = null;
        }
        function cerrarModalSiEsAfuera(event) { if (event.target === document.getElementById('modalImportarCliente')) { cerrarImportarCliente(); } }
        async function procesarArchivoImportado(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const d = await file.arrayBuffer(), w = XLSX.read(d), s = w.Sheets[w.SheetNames[0]], j = XLSX.utils.sheet_to_json(s, { header: 1 });
                datosClienteImportado = extraerDatosClienteExcel(j);
                if (datosClienteImportado && datosClienteImportado.nombre) { mostrarDatosImportados(datosClienteImportado); } 
                else { alert('No se pudieron extraer datos v√°lidos del archivo Excel.'); }
            } catch (error) { console.error('Error:', error); alert('Error al leer el archivo: ' + error.message); }
        }
        function extraerDatosClienteExcel(jsonData) {
            const c = {}, m = {'DESTINATARIO': 'nombre','RUT DESTINATARIO': 'rut','TEL√âFONO DESTINO': 'telefono','DIRECCI√ìN DESTINO': 'direccion','REFERENCIA': 'referencia','COMUNA DESTINO': 'comuna','VENDEDOR': 'vendedor','MEDIO DE TRANSPORTE': 'transporte'};
            jsonData.forEach(f => { if (f && f.length >= 2 && f[0] && f[1]) { const k = f[0].toString().trim().toUpperCase(), v = f[1].toString().trim(); if (m[k]) c[m[k]] = v; } });
            return c;
        }
        function mostrarDatosImportados(d) {
            document.getElementById('datosImportados').innerHTML = `<div style="background:#f0f9ff;padding:15px;border-radius:6px;border:1px solid #0ea5e9;"><h4 style="margin-bottom:10px;">üìã Datos:</h4><p><strong>Cliente:</strong> ${d.nombre||'N/A'}</p><p><strong>RUT:</strong> ${d.rut||'N/A'}</p><p><strong>Tel√©fono:</strong> ${d.telefono||'N/A'}</p></div>`;
            document.getElementById('resultadoImportacion').style.display = 'block';
        }
        function aplicarDatosImportados() {
            if (!datosClienteImportado) return;
            const d = datosClienteImportado;
            document.getElementById('envioDestinatario').value = d.nombre || '';
            document.getElementById('envioRut').value = d.rut || '';
            document.getElementById('envioTelefono').value = d.telefono || '';
            document.getElementById('envioDireccion').value = d.direccion || '';
            document.getElementById('envioReferencia').value = d.referencia || '';
            document.getElementById('envioComuna').value = d.comuna || '';
            if (d.transporte) {
                const s = document.getElementById('envioTransporte'), o = [...s.options].some(opt => opt.value === d.transporte);
                if (o) { s.value = d.transporte; document.getElementById('transporteOtroGroup').classList.add('hidden'); }
                else { s.value = 'Otro'; document.getElementById('transporteOtroGroup').classList.remove('hidden'); document.getElementById('envioTransporteOtro').value = d.transporte; }
            }
            alert('‚úÖ Datos del cliente cargados.');
            cerrarImportarCliente();
            if (d.rut) {
                const c = { ...d, fecha: new Date().toISOString() };
                let l = JSON.parse(localStorage.getItem('clientesImportados') || '[]');
                l = l.filter(i => i.rut !== c.rut);
                l.push(c);
                if (l.length > 50) l = l.slice(-50);
                localStorage.setItem('clientesImportados', JSON.stringify(l));
            }
        }
        function buscarClientePorRut() {
            const r = document.getElementById('envioRut').value.trim();
            if (!r || r.length < 8) return;
            const l = JSON.parse(localStorage.getItem('clientesImportados') || '[]'), f = l.find(c => c.rut.replace(/[.-]/g, '') === r.replace(/[.-]/g, ''));
            if (f) {
                document.getElementById('envioDestinatario').value = f.nombre || '';
                document.getElementById('envioTelefono').value = f.telefono || '';
                document.getElementById('envioDireccion').value = f.direccion || '';
                document.getElementById('envioReferencia').value = f.referencia || '';
                document.getElementById('envioComuna').value = f.comuna || '';
                if (f.transporte) document.getElementById('envioTransporte').value = f.transporte;
                mostrarMensajeTemporalCliente(`‚úÖ Cliente encontrado en cach√©: ${f.nombre}`);
            }
        }
        function mostrarMensajeTemporalCliente(m) {
            let d = document.getElementById('mensajeCliente');
            if (!d) {
                d = document.createElement('div');
                d.id = 'mensajeCliente';
                d.style.cssText = `background-color:#d1fae5;border:1px solid #10b981;color:#065f46;padding:8px 12px;border-radius:6px;margin-top:5px;font-size:14px;`;
                document.getElementById('envioRut').parentNode.appendChild(d);
            }
            d.innerHTML = m;
            d.style.display = 'block';
            setTimeout(() => { d.style.display = 'none'; }, 4000);
        }
        function poblarSelect(id, data) {
            const s = document.getElementById(id);
            s.innerHTML = '';
            for (const k in data) { const o = document.createElement('option'); o.value = k; o.textContent = k; s.appendChild(o); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const d = document.getElementById('comunasList');
            let c = [];
            for (const r in comunasPorRegion) { comunasPorRegion[r].forEach(com => c.push({ n: com, t: `${com} (${r})` })); }
            c.sort((a, b) => a.n.localeCompare(b.n)).forEach(i => { const o = document.createElement('option'); o.value = i.t; d.appendChild(o); });
            ['retiroVendedor', 'provisoriaVendedor', 'envioVendedor'].forEach(id => poblarSelect(id, vendedores));
            document.getElementById('envioTransporte').addEventListener('change', function() {
                const p = document.getElementById('envioPago');
                document.getElementById('transporteOtroGroup').classList.toggle('hidden', this.value !== 'Otro');
                p.disabled = false;
                if (this.value === 'TUTTO PETS') { p.value = 'Pagado'; p.disabled = true; alert('ATENCI√ìN: Env√≠o por TUTTO PETS debe ser PAGADO.'); }
                else if (this.value === 'JULIO MILLAN' || this.value === 'CHRISTIAN ALIAGA') { alert(`INFO: Para env√≠os con ${this.value}, el cobro "Por Pagar" lo gestiona el transporte.`); }
            });
        });

        function abrirModalPegar() {
            document.getElementById('modalPegarDatos').style.display = 'flex';
            document.getElementById('textoPegado').value = '';
            document.getElementById('textoPegado').focus();
        }

        function cerrarModalPegar() {
            document.getElementById('modalPegarDatos').style.display = 'none';
        }

        function procesarTextoPegado() {
            const texto = document.getElementById('textoPegado').value;
            if (!texto.trim()) return;

            let rut = "", nombre = "", documento = "", vendedor = "", telefono = "", direccion = "", comuna = "", transporte = "", pago = "", referencia = "";

            const lineas = texto.split('\n');
            lineas.forEach(linea => {
                const limpio = linea.trim();
                if (limpio.startsWith('RUT DESTINATARIO:')) rut = limpio.substring('RUT DESTINATARIO:'.length).trim();
                else if (limpio.startsWith('DESTINATARIO:')) nombre = limpio.substring('DESTINATARIO:'.length).trim();
                else if (limpio.startsWith('CLIENTE:')) nombre = limpio.substring('CLIENTE:'.length).trim();
                else if (limpio.startsWith('NOTA DE VENTA:')) documento = limpio.substring('NOTA DE VENTA:'.length).trim();
                else if (limpio.startsWith('TEL√âFONO DESTINO:')) telefono = limpio.substring('TEL√âFONO DESTINO:'.length).trim();
                else if (limpio.startsWith('DIRECCI√ìN DESTINO:')) direccion = limpio.substring('DIRECCI√ìN DESTINO:'.length).trim();
                else if (limpio.startsWith('REFERENCIA:')) referencia = limpio.substring('REFERENCIA:'.length).trim();
                else if (limpio.startsWith('COMUNA DESTINO:')) comuna = limpio.substring('COMUNA DESTINO:'.length).trim();
                else if (limpio.startsWith('MEDIO DE TRANSPORTE:')) transporte = limpio.substring('MEDIO DE TRANSPORTE:'.length).trim();
                else if (limpio.startsWith('FORMA DE PAGO:')) pago = limpio.substring('FORMA DE PAGO:'.length).trim();
                else if (limpio.startsWith('VENDEDOR:')) {
                    let vendRaw = limpio.substring('VENDEDOR:'.length).trim();
                    vendedor = vendRaw.split('-')[0].trim();
                }
            });

            const formRetiro = document.getElementById('formRETIRO').classList.contains('active');
            const formEnvio = document.getElementById('formENVIO').classList.contains('active');
            const formProvisoria = document.getElementById('formPROVISORIA').classList.contains('active');

            if (formEnvio) {
                if(nombre) document.getElementById('envioDestinatario').value = nombre;
                if(rut) document.getElementById('envioRut').value = rut;
                if(telefono) document.getElementById('envioTelefono').value = telefono;
                if(direccion) document.getElementById('envioDireccion').value = direccion;
                if(comuna) document.getElementById('envioComuna').value = comuna;
                if(documento) document.getElementById('envioNotaVenta').value = documento;
                if(referencia) document.getElementById('envioReferencia').value = referencia;
                if(vendedor) document.getElementById('envioVendedor').value = vendedor;
                
                if(transporte) {
                    const selectTrans = document.getElementById('envioTransporte');
                    let matched = false;
                    for(let i=0; i<selectTrans.options.length; i++){
                        if(selectTrans.options[i].value === transporte) {
                            selectTrans.selectedIndex = i;
                            matched = true;
                            break;
                        }
                    }
                    if(!matched && transporte) {
                        selectTrans.value = 'Otro';
                        document.getElementById('transporteOtroGroup').classList.remove('hidden');
                        document.getElementById('envioTransporteOtro').value = transporte;
                    }
                }
                if(pago) document.getElementById('envioPago').value = pago;
                
            } else if (formRetiro) {
                if(nombre) document.getElementById('retiroCliente').value = nombre;
                if(documento) document.getElementById('retiroNotaVenta').value = documento;
                if(vendedor) document.getElementById('retiroVendedor').value = vendedor;
            } else if (formProvisoria) {
                if(nombre) document.getElementById('provisoriaCliente').value = nombre;
                if(documento) document.getElementById('provisoriaNotaVenta').value = documento;
                if(vendedor) document.getElementById('provisoriaVendedor').value = vendedor;
            } else {
                alert("Primero selecciona un tipo de etiqueta (Retiro, Env√≠o, etc).");
                cerrarModalPegar();
                return;
            }

            alert('Datos cargados correctamente.');
            cerrarModalPegar();
        }

        function seleccionarModo(m, e) {
            modoActual = m;
            document.querySelectorAll('#modoSelectorSection .flex-btn').forEach(b => b.classList.remove('active'));
            e.classList.add('active');
            const f = document.querySelector('.form-section.active');
            if (f) {
                const b = f.querySelector('.btn-primary'), s = document.getElementById('batchSection');
                if (m === 'multiple') { b.textContent = '‚ûï Agregar Etiqueta al Lote'; f.appendChild(s); s.style.display = 'block'; }
                else { b.textContent = 'Generar Vista Previa'; s.style.display = 'none'; }
            }
            if(batchData.length > 0) { batchData = []; renderizarLote(); }
        }
        function renderizarLote() {
            const l = document.getElementById('batchList'), c = document.getElementById('batchCount');
            let t = 0;
            l.innerHTML = '';
            batchData.forEach((i, x) => {
                t += i.bultos;
                const n = (obtenerValor(i.datos, 'DESTINATARIO') || obtenerValor(i.datos, 'CLIENTE')).toUpperCase(), v = obtenerValor(i.datos, 'NOTA DE VENTA');
                const e = document.createElement('li');
                e.className = 'batch-item';
                e.innerHTML = `<div class="batch-item-info"><strong>${x + 1}.</strong> [${i.tipo}] ${n} (NV: ${v}) - <strong>${i.bultos} bulto(s)</strong></div><button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="eliminarDelLote(${x})">Eliminar</button>`;
                l.appendChild(e);
            });
            c.textContent = `${batchData.length} Entradas / ${t} Etiquetas Totales`;
        }
        function eliminarDelLote(i) { batchData.splice(i, 1); renderizarLote(); }
        function limpiarFormularioEnvio() { ['envioDestinatario','envioRut','envioTelefono','envioDireccion','envioReferencia','envioComuna','envioNotaVenta'].forEach(id => document.getElementById(id).value = ''); document.getElementById('envioBultos').value = '1'; }
        function limpiarFormularioRetiro() { ['retiroCliente','retiroNotaVenta','retiroContacto','retiraQuien','retiroObservaciones'].forEach(id => document.getElementById(id).value = ''); document.getElementById('retiroBultos').value = '1'; }
        function limpiarFormularioProvisoria() { ['provisoriaCliente','provisoriaNotaVenta','provisoriaObservaciones'].forEach(id => document.getElementById(id).value = ''); document.getElementById('provisoriaBultos').value = '1'; }
        function seleccionarTipo(t, e) {
            document.querySelectorAll('.selector-section:first-child .flex-btn').forEach(b => {
                if(!b.classList.contains('paste-btn')) b.classList.remove('active');
            });
            if(!e.classList.contains('paste-btn')) e.classList.add('active');
            
            document.querySelectorAll('.form-section, #previewSection').forEach(s => s.classList.remove('active'));
            document.getElementById(`form${t}`).classList.add('active');
            document.getElementById('modoSelectorSection').classList.remove('hidden');
            if (batchData.length > 0 && (!batchData[0] || batchData[0].tipo !== t)) { if (confirm('Al cambiar de tipo se limpiar√° el lote actual. ¬øContinuar?')) { batchData = []; renderizarLote(); } }
            const b = document.querySelector('#modoSelectorSection .flex-btn.active') || document.querySelector('#modoSelectorSection .flex-btn');
            seleccionarModo(modoActual, b);
        }
        
        function procesarRetiro() {
            const c = document.getElementById('retiroCliente').value.trim(), n = document.getElementById('retiroNotaVenta').value.trim();
            if (!c || !n) { alert('Cliente y Nota de Venta son obligatorios.'); return; }
            const v = document.getElementById('retiroVendedor').value, d = new Date();
            const contacto = document.getElementById('retiroContacto').value.trim();
            const retira = document.getElementById('retiraQuien').value.trim();
            
            const datosBase = [
                ['CLIENTE', c],
                ['NOTA DE VENTA', n],
                ['FECHA', `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`],
                ['VENDEDOR', `${v} - ${vendedores[v]}`]
            ];
            
            if(contacto) datosBase.push(['CONTACTO', contacto]);
            if(retira) datosBase.push(['RETIRA', retira]);
            datosBase.push(['OBSERVACIONES', document.getElementById('retiroObservaciones').value.trim()]);
            
            const e = { tipo: 'RETIRO', bultos: parseInt(document.getElementById('retiroBultos').value) || 1, datos: datosBase };
            if (modoActual === 'multiple') { batchData.push(e); renderizarLote(); limpiarFormularioRetiro(); alert(`‚úÖ Entrada para "${c}" agregada.`); }
            else { processedData = e; mostrarVistaPrevia(); }
        }
        
        function procesarProvisoria() {
            const c = document.getElementById('provisoriaCliente').value.trim(), n = document.getElementById('provisoriaNotaVenta').value.trim();
            if (!c || !n) { alert('Cliente y Nota de Venta son obligatorios.'); return; }
            const v = document.getElementById('provisoriaVendedor').value, d = new Date();
            const e = { tipo: 'PROVISORIA', bultos: parseInt(document.getElementById('provisoriaBultos').value) || 1, datos: [['CLIENTE', c],['NOTA DE VENTA', n],['FECHA', `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`],['VENDEDOR', `${v} - ${vendedores[v]}`],['OBSERVACIONES', document.getElementById('provisoriaObservaciones').value.trim()]] };
            if (modoActual === 'multiple') { batchData.push(e); renderizarLote(); limpiarFormularioProvisoria(); alert(`‚úÖ Entrada para "${c}" agregada.`); }
            else { processedData = e; mostrarVistaPrevia(); }
        }
        
        function obtenerDatosEnvioDelFormulario() {
            const c = {d:'envioDestinatario',r:'envioRut',t:'envioTelefono',a:'envioDireccion',o:'envioComuna',n:'envioNotaVenta'}, f = {};
            for (const k in c) { f[k] = document.getElementById(c[k]).value.trim(); }
            if (Object.values(f).some(v => !v)) { alert('Faltan campos obligatorios.'); return null; }
            let t = document.getElementById('envioTransporte').value;
            if (t === 'Otro') t = document.getElementById('envioTransporteOtro').value.trim() || 'Otro';
            const m = f.o.includes('(') ? f.o.substring(0, f.o.lastIndexOf('(') -1) : f.o;
            let g = 'No encontrada';
            for (const r in comunasPorRegion) { if (comunasPorRegion[r].includes(m)) { g = r; break; } }
            const u = (g === 'Metropolitana de Santiago') ? 'Santiago' : m, v = document.getElementById('envioVendedor').value, e = document.getElementById('envioReferencia').value.trim();
            const d = [['DE','SOC INV FUCAS SPA - RUT: 76.230.392-2'],['VENDEDOR',`${v} - ${vendedores[v]}`],['DIRECCI√ìN','AV LO ESPEJO 02360, SAN BERNARDO, SANTIAGO'],['TEL√âFONO','2 3347 5040'],['SEPARADOR_1',''],['DESTINATARIO',f.d],['RUT DESTINATARIO',f.r],['TEL√âFONO DESTINO',f.t],['DIRECCI√ìN DESTINO',f.a],...(e ? [['REFERENCIA', e]] : []),['COMUNA DESTINO',f.o],['CIUDAD DESTINO',u],['REGI√ìN',g],['SEPARADOR_2',''],['TIPO DE ENV√çO',document.getElementById('envioTipo').value],['MEDIO DE TRANSPORTE',t],['FORMA DE PAGO',document.getElementById('envioPago').value],['NOTA DE VENTA',f.n]];
            return { tipo: 'ENVIO', bultos: parseInt(document.getElementById('envioBultos').value) || 1, datos: d, pagaAromaker: pagaAromakerActivo };
        }
        
        function procesarEnvio() {
            const d = obtenerDatosEnvioDelFormulario();
            if (!d) return;
            if (modoActual === 'multiple') { batchData.push(d); renderizarLote(); limpiarFormularioEnvio(); alert(`‚úÖ Entrada para "${d.datos.find(i=>i[0]==='DESTINATARIO')[1]}" agregada.`); }
            else { processedData = d; mostrarVistaPrevia(); }
        }
        function procesarLote() { if (batchData.length === 0) { alert('No hay etiquetas en el lote.'); return; } processedData = { tipo: 'LOTE', lote: batchData }; generarVistaImprimible(); }
        function mostrarVistaPrevia() {
            if (!processedData) return;
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('successMessage').classList.add('active');
            const t = document.getElementById('previewTable');
            t.innerHTML = '';
            processedData.datos.filter(f => !f[0].startsWith('SEPARADOR')).forEach(f => { t.innerHTML += `<tr><td style="font-weight:600;">${f[0]||''}</td><td>${f[1]||''}</td></tr>`; });
        }
        
        function generarContenidoEtiquetaHTML(d) {
            if (d.tipo === 'RETIRO' || d.tipo === 'PROVISORIA') {
                let t = `<div class="titulo-etiqueta ${d.tipo==='PROVISORIA'?'titulo-provisoria':''}">${'ETIQUETA '+d.tipo}</div>`, m = '<div class="retiro-main">';
                d.datos.filter(f => f[0]==='CLIENTE'||f[0]==='NOTA DE VENTA').forEach(f => { m += `<p class="${f[0].includes('NOTA')?'nota-venta':''}"><span class="campo">${f[0]}:</span> ${f[1]}</p>`; });
                m += '</div>';
                let f = `<div class="seccion-remitente">`;
                d.datos.filter(i => i[0]==='FECHA'||i[0]==='VENDEDOR'||i[0]==='CONTACTO'||i[0]==='RETIRA'||i[0]==='OBSERVACIONES').forEach(i => { if(i[1]) f += `<p><span class="campo">${i[0]}:</span> ${i[1]}</p>`; });
                f += '</div>';
                return `${t}${m}${f}`;
            } else {
                let r='<div class="seccion seccion-remitente">', a='<div class="seccion seccion-destinatario">', e='<div class="seccion seccion-envio">', c='remitente';
                d.datos.forEach(f => {
                    if (f[0].startsWith('SEPARADOR')) { c = (c==='remitente')?'destinatario':'envio'; return; }
                    if (!f[0]||!f[1]) return;
                    let l = `<p class="${f[0].includes('NOTA')?'nota-venta':''}"><span class="campo">${f[0]}:</span> ${f[1]}</p>`;
                    if(c==='remitente') r+=l; else if(c==='destinatario') a+=l; else e+=l;
                });
                return `<div class="bulto-manual">BULTOS: ______ / ______</div>${r}</div><div class="separador"></div>${a}</div><div class="separador"></div>${e}</div>`;
            }
        }

        function generarVistaImprimible() {
    if (!processedData) { alert('Primero debes procesar los datos.'); return; }
    enviarAGoogleSheets(processedData);
    const w = window.open('', '_blank');
    
    let usarMarcadorPaga = false;
    if (processedData.tipo === 'ENVIO' && processedData.pagaAromaker) {
        usarMarcadorPaga = true;
    } else if (processedData.tipo === 'LOTE' && processedData.lote && processedData.lote.length > 0) {
        usarMarcadorPaga = processedData.lote.some(item => item.pagaAromaker);
    }
    
    let c = `<html><head><title>Etiquetas</title><style>
body{margin:0;font-family:sans-serif}
.pagina{display:flex;flex-wrap:wrap;justify-content:space-around;align-content:flex-start;width:21.59cm;height:27.94cm;padding:0.5cm;box-sizing:border-box;page-break-after:always}
.etiqueta{display:flex;flex-direction:column;border:1.5px dashed #777;padding:6px 10px;box-sizing:border-box;line-height:1.3;overflow-wrap:break-word;position:relative}
.etiqueta-envio{width:49%;height:48%;margin-bottom:.5cm}
.etiqueta-retiro,.etiqueta-provisoria{width:100%;height:48%;margin-bottom:2%}
.titulo-etiqueta{text-align:center;font-weight:700;font-size:1.4em;margin-bottom:5px;border-bottom:1.5px solid #000;padding-bottom:3px}
.titulo-provisoria{background-color:#ffc}
.bulto-manual{text-align:center;font-weight:700;font-size:1.2em;margin-bottom:5px;border-bottom:1.5px solid #000;padding-bottom:3px}
.seccion p{margin:1px 0}
.seccion-remitente{font-size:8pt}
.seccion-destinatario{font-size:11pt;flex-grow:2;display:flex;flex-direction:column;justify-content:center}
.seccion-destinatario p,.seccion-envio .nota-venta,.retiro-main{text-transform:uppercase}
.seccion-envio{font-size:11pt;flex-grow:1;display:flex;flex-direction:column;justify-content:flex-end}
.retiro-main{flex-grow:1;display:flex;flex-direction:column;justify-content:center;font-size:16pt}
.campo{font-weight:700}
.separador{border-top:1.5px solid #000;margin:5px 0}
.nota-venta{font-weight:700;font-size:18pt!important}
${usarMarcadorPaga ? `
.etiqueta-con-marca{padding:24px 20px 24px 20px!important}
.marca-paga-container{position:absolute;inset:0;pointer-events:none;z-index:10}
.marca-paga-top,.marca-paga-bottom{position:absolute;left:0;right:0;height:18px;background:#000;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:9px;color:#fff;letter-spacing:2px}
.marca-paga-top{top:0}
.marca-paga-bottom{bottom:0}
.marca-paga-left,.marca-paga-right{position:absolute;top:0;bottom:0;width:15px;background:#000;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:8px;color:#fff;writing-mode:vertical-rl;letter-spacing:2px}
.marca-paga-left{left:0}
.marca-paga-right{right:0;writing-mode:vertical-lr}
.marca-p-circulo{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border:4px solid #000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;font-weight:900;color:#000;opacity:0.15;z-index:5}
` : ''}
@media print{.no-imprimir{display:none}}
</style></head><body><div class="no-imprimir" style="text-align:center;padding:15px;background:#eee;"><h2>Vista de Impresi√≥n</h2><button onclick="window.print()">Imprimir</button> <button onclick="window.close()">Cerrar</button></div>`;
    
    let h = '';
    if (processedData.tipo === 'LOTE' && processedData.lote) {
        let g = 0, l = processedData.lote, t = l.reduce((s, i) => s + i.bultos, 0), o = l.length > 0 ? l[0].tipo : 'ENVIO';
        const p = (o === 'RETIRO' || o === 'PROVISORIA') ? 2 : 4, s = `etiqueta-${o.toLowerCase()}`;
        l.forEach(item => { 
            const e = generarContenidoEtiquetaHTML(item); 
            const marcaPaga = item.pagaAromaker ? '<div class="marca-paga-container"><div class="marca-paga-top">*** PAGA AROMAKER ***</div><div class="marca-paga-bottom">*** PAGA AROMAKER ***</div><div class="marca-paga-left">*** PAGA AROMAKER ***</div><div class="marca-paga-right">*** PAGA AROMAKER ***</div><div class="marca-p-circulo">P</div></div>' : '';
            const claseExtra = item.pagaAromaker ? ' etiqueta-con-marca' : '';
            for (let i = 0; i < item.bultos; i++) { 
                h += `<div class="etiqueta ${s}${claseExtra}">${e}${marcaPaga}</div>`; 
                g++; 
                if (g % p === 0 && g < t) h += `</div><div class="pagina">`; 
            } 
        });
    } else {
        const marcaPaga = processedData.pagaAromaker ? '<div class="marca-paga-container"><div class="marca-paga-top">*** PAGA AROMAKER ***</div><div class="marca-paga-bottom">*** PAGA AROMAKER ***</div><div class="marca-paga-left">*** PAGA AROMAKER ***</div><div class="marca-paga-right">*** PAGA AROMAKER ***</div><div class="marca-p-circulo">P</div></div>' : '';
        const claseExtra = processedData.pagaAromaker ? ' etiqueta-con-marca' : '';
        for (let i = 1; i <= processedData.bultos; i++) {
            const e = generarContenidoEtiquetaHTML(processedData), r = processedData.tipo === 'RETIRO' || processedData.tipo === 'PROVISORIA', s = `etiqueta-${processedData.tipo.toLowerCase()}`;
            h += `<div class="etiqueta ${s}${claseExtra}">${e}${marcaPaga}</div>`;
            if (i % (r ? 2 : 4) === 0 && i < processedData.bultos) h += `</div><div class="pagina">`;
        }
    }
    w.document.write(c + `<div class="pagina">${h}</div></body></html>`);
    w.document.close();
}
        
        function generarExcel() {
            if (!processedData || processedData.tipo === 'LOTE') { alert('Funci√≥n solo para modo individual.'); return; }
            const w = XLSX.utils.book_new(), d = [];
            const b = processedData.datos.filter(f => !f[0].startsWith('SEPARADOR'));
            for (let i = 1; i <= processedData.bultos; i++) { b.forEach((r, x) => { if (!d[x]) d[x] = []; const s = (i-1)*3; while (d[x].length < s) d[x].push(null); d[x].push(r[0], r[1]); }); }
            const s = XLSX.utils.aoa_to_sheet(d), c = [];
            for (let i=0; i<processedData.bultos; i++) c.push({wch:35},{wch:35},{wch:5});
            s['!cols'] = c;
            XLSX.utils.book_append_sheet(w, s, 'Etiquetas');
            const n = (obtenerValor(processedData.datos, 'CLIENTE') || obtenerValor(processedData.datos, 'DESTINATARIO')).replace(/ /g, '_');
            XLSX.writeFile(w, `Etiquetas_${n}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        function copiarParaSheets() {
             if (!processedData || processedData.tipo === 'LOTE') { alert('Funci√≥n solo para modo individual.'); return; }
            const d = [];
            const b = processedData.datos.filter(f => !f[0].startsWith('SEPARADOR'));
            for (let i = 1; i <= processedData.bultos; i++) { b.forEach((r, x) => { if (!d[x]) d[x] = []; const s = (i-1)*3; while (d[x].length < s) d[x].push(''); d[x].push(r[0], r[1]); }); }
            navigator.clipboard.writeText(d.map(r => r.join('\t')).join('\n')).then(() => alert('Datos copiados para Sheets.')).catch(e => console.error(e));
        }
        function mostrarDatosCopiables() {
            if (processedData.tipo === 'LOTE') { alert('Funci√≥n solo para modo individual.'); return; }
            const c = document.getElementById('copySection');
            c.classList.toggle('hidden');
            if (!c.classList.contains('hidden')) { document.getElementById('copyTextarea').value = processedData.datos.map(f => `${f[0]}: ${f[1]}`).join('\n').trim(); }
        }
        function copiarAlPortapapeles() { navigator.clipboard.writeText(document.getElementById('copyTextarea').value).then(() => alert('¬°Datos copiados!')).catch(e => console.error(e)); }
        function volverInicio() { window.location.reload(); }
    </script>
</body>
</html>
